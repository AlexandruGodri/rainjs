<html>
	<head>
		<title>Rain Documentation</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>Rain Documentation</h1></td><td></td></tr><tr class="filename"><td><h2 id="../lib/cache.js"><a href="#">cache</a></h2></td><td>../lib/cache.js</td></tr><tr class="code">
<td class="docs">
<p>Caching module. Works in-node-memory (simple JavaScript object) and using redis. </p>

<h2></h2>

<ul><li><p><strong>type</strong>: <em>String</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">mod_promise</span>         = <span class="variable">require</span>(<span class="string">'promised-io'</span>)
    , <span class="variable">mod_resources</span>     = <span class="variable">require</span>(<span class="string">'./resources.js'</span>)
    , <span class="variable">mod_redback</span>       = <span class="keyword">null</span>
    , <span class="variable">redbackClient</span>     = <span class="keyword">null</span>
    , <span class="variable">config</span>            = <span class="keyword">null</span>
    , <span class="variable">logger</span>            = <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'Cache'</span>, <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="class">Logger</span>.<span class="class">SEVERITY</span>.<span class="class">ERROR</span>)
    , <span class="variable">cache</span>             = <span class="keyword">null</span>

<span class="comment">// var _cache = {};</span>
<span class="comment">// var cache = {</span>
<span class="comment">//     add : function (key, value, cb) {</span>
<span class="comment">//         if (typeof _cache[key] === 'undefined') {</span>
<span class="comment">//             _cache[key] = value;</span>
<span class="comment">//         }</span>
<span class="comment">//         cb();</span>
<span class="comment">//     }</span>
<span class="comment">//     , get : function (key, cb) {</span>
<span class="comment">//         cb(null, _cache[key] ? _cache[key] : null);</span>
<span class="comment">//     }</span>
<span class="comment">//     , set : function (key, value, exp, cb) {</span>
<span class="comment">//         _cache[key] = value;</span>
<span class="comment">//         cb();</span>
<span class="comment">//     } </span>
<span class="comment">//     ,exists : function (key, cb) { </span>
<span class="comment">//         cb(typeof _cache[key] !== 'undefined');</span>
<span class="comment">//     }</span>
<span class="comment">// }</span>

<span class="keyword">function</span> <span class="variable">configure</span>(<span class="variable">c</span>) {
    <span class="variable">config</span> = <span class="variable">c</span>;
    <span class="keyword">if</span> (<span class="variable">config</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">config</span>.<span class="variable">caching</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">config</span>.<span class="variable">caching</span>.<span class="variable">resources</span>) {
        <span class="variable">logger</span>.<span class="variable">debug</span>(<span class="string">'activate caching'</span>);
        <span class="variable">mod_redback</span> = <span class="variable">require</span>(<span class="string">'redback'</span>);
        <span class="variable">redbackClient</span> = <span class="variable">mod_redback</span>.<span class="variable">createClient</span>();
        <span class="variable">cache</span> = <span class="variable">redbackClient</span>.<span class="variable">createCache</span>(<span class="string">'rain'</span>);
    }

}

<span class="keyword">function</span> <span class="variable">toCache</span>(<span class="variable">url</span>, <span class="variable">data</span>) {
    <span class="keyword">if</span> (<span class="variable">cache</span>) {
        <span class="variable">logger</span>.<span class="variable">debug</span>(<span class="string">'write to cache; url: '</span> + <span class="variable">url</span>);
        <span class="comment">// [TBD] error handling</span>
        <span class="variable">cache</span>.<span class="variable">set</span>(<span class="variable">url</span>, <span class="variable">data</span>, <span class="variable">config</span>.<span class="variable">caching</span>.<span class="variable">ttl</span>, <span class="keyword">function</span> () {
            <span class="comment">//logger.debug('written to cache');</span>
        });
    }
}

<span class="keyword">function</span> <span class="variable">fromCache</span>(<span class="variable">url</span>) {
    <span class="keyword">var</span> <span class="variable">defer</span> = <span class="variable">mod_promise</span>.<span class="variable">defer</span>()
        , <span class="variable">cr</span>

    <span class="keyword">if</span> (<span class="variable">cache</span>) {
        <span class="variable">cache</span>.<span class="variable">exists</span>(<span class="variable">url</span>, <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">exists</span>) {
            <span class="comment">// [TBD] error handling</span>
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>.<span class="variable">toString</span>());
                <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="keyword">null</span>);
            }
            <span class="keyword">if</span> (<span class="variable">exists</span>) {
                <span class="variable">cache</span>.<span class="variable">get</span>(<span class="variable">url</span>, <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">value</span>) {
                    <span class="keyword">if</span> (<span class="variable">err</span>) {
                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>);
                    } <span class="keyword">else</span> {
                        <span class="variable">logger</span>.<span class="variable">debug</span>(<span class="string">'got from cache; url: '</span> + <span class="variable">url</span>);
                        <span class="variable">cr</span> = <span class="keyword">new</span> <span class="variable">mod_resources</span>.<span class="class">Resource</span>(<span class="variable">url</span>, <span class="variable">value</span>);
                        <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="variable">cr</span>);
                    }  
                });
            } <span class="keyword">else</span> {
                <span class="variable">logger</span>.<span class="variable">debug</span>(<span class="string">'not found in cache; url: '</span> + <span class="variable">url</span>);
                <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="keyword">null</span>);
            }
        });
    } <span class="keyword">else</span> {
        <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="keyword">null</span>);
    }
    <span class="keyword">return</span> <span class="variable">defer</span>;
}

<span class="variable">exports</span>.<span class="variable">fromCache</span>   = <span class="variable">fromCache</span>;
<span class="variable">exports</span>.<span class="variable">toCache</span>     = <span class="variable">toCache</span>;
<span class="variable">exports</span>.<span class="variable">configure</span>   = <span class="variable">configure</span>;</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/cssnormalizer.js"><a href="#">cssnormalizer</a></h2></td><td>../lib/cssnormalizer.js</td></tr><tr class="code">
<td class="docs">
<p>This module normalizes URLs in CSS files provided by modules to absolute paths
that are valid on an individual module host. </p>

<p> </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">mod_path</span>			= <span class="variable">require</span>(<span class="string">'path'</span>)
	<span class="variable">mod_assert</span>			= <span class="variable">require</span>(<span class="string">'assert'</span>)
 	 , <span class="variable">c</span> 				= <span class="variable">console</span>.<span class="variable">log</span></code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Normalizes a URL in a CSS file. Does not change fully-qualified http:// URLs. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  data CSS data</p></li><li><p><strong>param</strong>: <em>String</em>  path root path </p></li><li><p><strong>param</strong>: <em>String</em>  orighost URL of old source host</p></li><li><p><strong>param</strong>: <em>String</em>  newhost URL of new source host</p></li><li><p><strong>return</strong>: <em>String</em>  normalized CSS data</p></li><li><p><strong>publi</strong>: <em>c</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">normalize</span>(<span class="variable">data</span>, <span class="variable">path</span>, <span class="variable">orighost</span>, <span class="variable">newhost</span>) {
	<span class="keyword">var</span> <span class="variable">data</span> = <span class="variable">data</span>.<span class="variable">replace</span>(<span class="regexp">/url\(['&quot;]?([^'&quot;\)']+)['&quot;]?\)?/mg</span>, <span class="keyword">function</span> () {
		<span class="keyword">var</span> <span class="variable">p</span>;
		<span class="keyword">if</span> (<span class="variable">arguments</span>[<span class="number integer">1</span>].<span class="variable">indexOf</span>(<span class="string">'http://'</span>) === <span class="number integer">0</span>) { <span class="keyword">return</span> <span class="variable">arguments</span>[<span class="number integer">1</span>]; }
		<span class="variable">p</span> = <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">path</span>, <span class="variable">arguments</span>[<span class="number integer">1</span>]); 
		<span class="keyword">if</span> (<span class="variable">orighost</span> !== <span class="variable">newhost</span>) { <span class="variable">p</span> = <span class="variable">newhost</span> + <span class="variable">p</span>; }
		<span class="variable">p</span> = <span class="string">'url(\&quot;'</span> + <span class="variable">p</span> + <span class="string">'\&quot;)'</span>;
		<span class="keyword">return</span> <span class="variable">p</span>;
 	});
 	<span class="keyword">return</span> <span class="variable">data</span>;
}

<span class="variable">exports</span>.<span class="variable">normalize</span> = <span class="variable">normalize</span>;</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/logger.js"><a href="#">logger</a></h2></td><td>../lib/logger.js</td></tr><tr class="code">
<td class="docs">
<p>Logger module. 
Has appenders for console and HTTP. </p>

<p> </p>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getLogger</span> (<span class="variable">name</span>, <span class="variable">level</span>) {
    <span class="keyword">var</span> <span class="variable">l</span> = <span class="keyword">typeof</span> <span class="variable">level</span> !== <span class="string">'undefined'</span> ? <span class="variable">level</span> : <span class="class">Logger</span>.<span class="class">SEVERITY</span>.<span class="class">INFO</span>
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="class">Logger</span>(<span class="variable">name</span>, <span class="variable">l</span>);
}

<span class="keyword">function</span> <span class="class">Logger</span>(<span class="variable">name</span>, <span class="variable">level</span>) {
    <span class="keyword">if</span> (<span class="string">'undefined'</span> === <span class="keyword">typeof</span> <span class="variable">name</span>) { <span class="variable">name</span> = <span class="string">''</span> }
    <span class="this">this</span>.<span class="variable">appender</span> = [ <span class="keyword">new</span> <span class="class">ConsoleAppender</span>() ]; <span class="comment">// yes, I know... </span>
    <span class="this">this</span>.<span class="variable">name</span> = <span class="variable">name</span>;
    <span class="this">this</span>.<span class="variable">level</span> = <span class="variable">level</span>;
}
<span class="class">Logger</span>.<span class="class">SEVERITY</span> = {
    <span class="class">INFO</span>  : <span class="number integer">5</span>,
    <span class="class">DEBUG</span> : <span class="number integer">4</span>,
    <span class="class">WARN</span>  : <span class="number integer">3</span>,
    <span class="class">ERROR</span> : <span class="number integer">2</span>
}

<span class="comment">//</span>
<span class="comment">// [TBD] add argument style and join </span>
<span class="comment">//</span>
<span class="class">Logger</span>.<span class="variable">prototype</span>.<span class="variable">info</span> = <span class="keyword">function</span> (<span class="variable">msg</span>) {
  <span class="this">this</span>.<span class="variable">_log</span>(<span class="variable">msg</span>, <span class="class">Logger</span>.<span class="class">SEVERITY</span>.<span class="class">INFO</span>);
}
<span class="class">Logger</span>.<span class="variable">prototype</span>.<span class="variable">debug</span> = <span class="keyword">function</span> (<span class="variable">msg</span>) {
  <span class="this">this</span>.<span class="variable">_log</span>(<span class="variable">msg</span>, <span class="class">Logger</span>.<span class="class">SEVERITY</span>.<span class="class">DEBUG</span>);
}
<span class="class">Logger</span>.<span class="variable">prototype</span>.<span class="variable">warn</span> = <span class="keyword">function</span> (<span class="variable">msg</span>) {
  <span class="this">this</span>.<span class="variable">_log</span>(<span class="variable">msg</span>, <span class="class">Logger</span>.<span class="class">SEVERITY</span>.<span class="class">WARN</span>);
}
<span class="class">Logger</span>.<span class="variable">prototype</span>.<span class="variable">error</span> = <span class="keyword">function</span> (<span class="variable">msg</span>) {
  <span class="this">this</span>.<span class="variable">_log</span>(<span class="variable">msg</span>, <span class="class">Logger</span>.<span class="class">SEVERITY</span>.<span class="class">ERROR</span>);
}
<span class="class">Logger</span>.<span class="variable">prototype</span>.<span class="variable">_log</span> = <span class="keyword">function</span> (<span class="variable">msg</span>, <span class="variable">level</span>) {
  <span class="keyword">if</span> (<span class="variable">level</span> &<span class="variable">gt</span>; <span class="this">this</span>.<span class="variable">level</span>) { <span class="keyword">return</span>; }
  <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="this">this</span>.<span class="variable">appender</span>.<span class="variable">length</span>; --<span class="variable">i</span> &<span class="variable">gt</span>;= <span class="number integer">0</span>;) {
    <span class="this">this</span>.<span class="variable">appender</span>[<span class="variable">i</span>].<span class="variable">append</span>(<span class="variable">msg</span>, <span class="this">this</span>.<span class="variable">name</span>, <span class="variable">level</span>);
  }
}

<span class="keyword">function</span> <span class="class">ConsoleAppender</span> () {
}
<span class="class">ConsoleAppender</span>.<span class="variable">prototype</span>.<span class="variable">append</span> = <span class="keyword">function</span> (<span class="variable">msg</span>, <span class="variable">logger</span>, <span class="variable">level</span>) {
    <span class="keyword">var</span> <span class="variable">col</span> = <span class="variable">level</span> == <span class="number integer">2</span> ? <span class="string">'\033[31m'</span> : <span class="string">'\033[32m'</span>,
        <span class="variable">msg</span> = <span class="variable">logger</span> != <span class="string">''</span> ? (<span class="variable">col</span> + <span class="variable">logger</span> + <span class="string">':\033[39m '</span> + <span class="variable">msg</span> ) : <span class="variable">msg</span>
    <span class="comment">// there's no console.debug, map debug to console.info</span>
    <span class="keyword">var</span> <span class="variable">lvls</span> = {<span class="string">'5'</span>:<span class="string">'info'</span>, <span class="string">'4'</span>:<span class="string">'info'</span>, <span class="string">'3'</span>:<span class="string">'warn'</span>, <span class="string">'2'</span> :<span class="string">'error'</span>};
    <span class="variable">console</span>[<span class="variable">lvls</span>[<span class="variable">level</span>]](<span class="variable">msg</span>);
}

<span class="keyword">function</span> <span class="class">HttpLogHostAppender</span> (<span class="variable">url</span>) {  
    <span class="keyword">var</span> <span class="variable">opts</span> = <span class="variable">parseUri</span>(<span class="variable">url</span>);
    <span class="this">this</span>.<span class="variable">options</span> = {
        <span class="variable">host</span>: <span class="variable">opts</span>.<span class="variable">host</span>,
        <span class="variable">port</span>: <span class="variable">opts</span>.<span class="variable">port</span>,
        <span class="variable">path</span>: <span class="variable">opts</span>.<span class="variable">path</span>,
        <span class="variable">method</span>: <span class="string">'POST'</span>,
        <span class="variable">headers</span> : {
            &<span class="variable">quot</span>;<span class="class">Content</span>-<span class="class">Type</span>&<span class="variable">quot</span>; : &<span class="variable">quot</span>;<span class="variable">application</span>/<span class="variable">json</span>&<span class="variable">quot</span>;
        }
    }; 
}
<span class="class">HttpLogHostAppender</span>.<span class="variable">prototype</span>.<span class="variable">append</span> = <span class="keyword">function</span> (<span class="variable">msg</span>, <span class="variable">logger</span>, <span class="variable">level</span>) {
    <span class="keyword">var</span> <span class="variable">req</span> = <span class="variable">http</span>.<span class="variable">request</span>(<span class="this">this</span>.<span class="variable">options</span>, <span class="keyword">function</span>(<span class="variable">res</span>) {
      <span class="variable">res</span>.<span class="variable">setEncoding</span>(<span class="string">'utf8'</span>);
      <span class="variable">res</span>.<span class="variable">on</span>(<span class="string">'data'</span>, <span class="keyword">function</span> (<span class="variable">chunk</span>) {});
    });
    <span class="keyword">var</span> <span class="variable">data</span> = {};
    <span class="variable">data</span>.<span class="variable">msg</span> = <span class="variable">msg</span>;
    <span class="variable">data</span>.<span class="variable">origin</span> = <span class="variable">logger</span>;
    <span class="variable">data</span>.<span class="variable">timestamp</span> = <span class="keyword">new</span> <span class="class">Date</span>().<span class="variable">getTime</span>();
    <span class="keyword">try</span> {
        <span class="variable">req</span>.<span class="variable">write</span>(<span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="variable">data</span>));    
    } <span class="keyword">catch</span> (<span class="variable">error</span>) {
        <span class="comment">// JSON.stringify does not allow circular references, so we need to </span>
        <span class="comment">// catch that here</span>
    }
    <span class="variable">req</span>.<span class="variable">end</span>();
}

<span class="variable">exports</span>.<span class="variable">getLogger</span>   = <span class="variable">getLogger</span>;
<span class="variable">exports</span>.<span class="class">Logger</span>      = <span class="class">Logger</span>;</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/modules.js"><a href="#">modules</a></h2></td><td>../lib/modules.js</td></tr><tr class="code">
<td class="docs">
<h2></h2>

<ul><li><p><strong>type</strong>: <em>String</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">mod_sys</span>                 = <span class="variable">require</span>(<span class="string">'sys'</span>)
    , <span class="variable">mod_path</span>              = <span class="variable">require</span>(<span class="string">'path'</span>)
    , <span class="variable">mod_fs</span>                = <span class="variable">require</span>(<span class="string">'fs'</span>)
    , <span class="variable">mod_promise</span>           = <span class="variable">require</span>(<span class="string">'promised-io'</span>)
    , <span class="variable">mod_jsdom</span>             = <span class="variable">require</span>(<span class="string">'jsdom'</span>)
    , <span class="variable">mod_url</span>               = <span class="variable">require</span>(<span class="string">'url'</span>)
    , <span class="variable">mod_querystring</span>       = <span class="variable">require</span>(<span class="string">'querystring'</span>)
    , <span class="variable">mod_renderer</span>          = <span class="variable">require</span>(<span class="string">'./renderer.js'</span>)
    , <span class="variable">mod_resourcemanager</span>   = <span class="variable">require</span>(<span class="string">'./resourcemanager.js'</span>)
    , <span class="variable">tagmanager</span>            = <span class="keyword">null</span>
    , <span class="variable">config</span>                = <span class="keyword">null</span>
    , <span class="variable">taglibrary</span>            = <span class="keyword">null</span>
    , <span class="variable">moduleRootFolder</span>      = <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">__dirname</span>, <span class="string">'..'</span>, <span class="string">'modules'</span>)
    , <span class="variable">logger</span>                = <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'Modules'</span>)

<span class="keyword">function</span> <span class="variable">configure</span>(<span class="variable">c</span>, <span class="variable">t</span>) {
    <span class="variable">config</span> = <span class="variable">c</span>;
    <span class="variable">tagmanager</span> = <span class="variable">t</span>;
}

<span class="keyword">function</span> <span class="variable">handleControllerRequest</span> (<span class="variable">req</span>, <span class="variable">res</span>, <span class="variable">next</span>) {
    <span class="variable">logger</span>.<span class="variable">debug</span>(<span class="string">'handleControllerRequest '</span> + <span class="variable">req</span>.<span class="variable">url</span>);
    <span class="keyword">var</span> <span class="variable">modulename</span> = <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">0</span>]
        , <span class="variable">method</span> = <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">1</span>]
        , <span class="variable">mp</span> = <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">moduleRootFolder</span>, <span class="string">'modules'</span>, <span class="variable">modulename</span>, <span class="string">'main.js'</span>)

    <span class="variable">mod_path</span>.<span class="variable">exists</span>(<span class="variable">mp</span>, <span class="keyword">function</span> (<span class="variable">exists</span>) {
        <span class="keyword">if</span> (<span class="variable">exists</span>) {
            <span class="keyword">var</span> <span class="variable">module</span> = <span class="variable">require</span>(<span class="variable">mp</span>);
            <span class="keyword">if</span> (<span class="variable">module</span>[<span class="variable">method</span>]) {
                <span class="variable">module</span>[<span class="variable">method</span>](<span class="variable">req</span>, <span class="variable">res</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">ret</span>) {
                    <span class="variable">res</span>.<span class="variable">end</span>(<span class="variable">ret</span>.<span class="variable">data</span>);
                });
            } <span class="keyword">else</span> {
                <span class="variable">res</span>.<span class="variable">writeHead</span>(<span class="number integer">404</span>, { <span class="string">'Content-Type'</span> : <span class="string">'text/plain'</span>} );
                <span class="variable">res</span>.<span class="variable">end</span>(<span class="string">'method not available'</span>);
            }   
        } <span class="keyword">else</span> {
            <span class="variable">res</span>.<span class="variable">writeHead</span>(<span class="number integer">404</span>, { <span class="string">'Content-Type'</span> : <span class="string">'text/plain'</span>} );
            <span class="variable">res</span>.<span class="variable">end</span>(<span class="string">'unknown module '</span> + <span class="variable">modulename</span>);
        }
    });
}

<span class="keyword">function</span> <span class="variable">handleScriptRequest</span> (<span class="variable">req</span>, <span class="variable">res</span>, <span class="variable">next</span>) {
    <span class="keyword">var</span> <span class="variable">modulename</span> = <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">0</span>]
        , <span class="variable">path</span> = <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">1</span>]
        , <span class="variable">mp</span> = <span class="string">'file://'</span> + <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">moduleRootFolder</span>, <span class="variable">modulename</span>, <span class="string">'htdocs'</span>, <span class="variable">path</span>);
    <span class="variable">logger</span>.<span class="variable">debug</span>(<span class="string">'handleScriptRequest '</span> + <span class="variable">mp</span>);
    <span class="variable">res</span>.<span class="variable">setHeader</span>(<span class="string">'Content-Type'</span>, <span class="string">'text/javascript'</span>);
    <span class="variable">mod_resourcemanager</span>.<span class="variable">getResource</span>(<span class="variable">mp</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
        <span class="variable">res</span>.<span class="variable">end</span>(<span class="variable">resource</span>.<span class="variable">data</span>.<span class="variable">toString</span>());
    });
}

<span class="keyword">function</span> <span class="variable">handleViewRequest</span> (<span class="variable">req</span>, <span class="variable">res</span>, <span class="variable">next</span>) {
    <span class="keyword">var</span> <span class="variable">query</span> = <span class="variable">mod_querystring</span>.<span class="variable">parse</span>(<span class="variable">mod_url</span>.<span class="variable">parse</span>(<span class="variable">req</span>.<span class="variable">url</span>).<span class="variable">query</span>)
        , <span class="variable">mode</span> = <span class="variable">query</span>.<span class="variable">type</span>
        , <span class="variable">baseurl</span> = <span class="variable">req</span>.<span class="variable">url</span>.<span class="variable">substring</span>(<span class="number integer">0</span>, <span class="variable">req</span>.<span class="variable">url</span>.<span class="variable">lastIndexOf</span>(<span class="string">'/'</span>))
        , <span class="variable">modulename</span> = <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">0</span>]
        , <span class="variable">viewname</span> = <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">1</span>]
    <span class="variable">logger</span>.<span class="variable">debug</span>(<span class="string">'handleViewRequest, module: '</span> + <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">0</span>] + <span class="string">', view: '</span> + <span class="variable">req</span>.<span class="variable">params</span>[<span class="number integer">1</span>]);

    <span class="keyword">var</span> <span class="variable">r</span> = <span class="keyword">new</span> <span class="variable">mod_renderer</span>.<span class="class">Renderer</span>(<span class="variable">tagmanager</span>);
    <span class="variable">console</span>.<span class="variable">time</span>(<span class="string">'render'</span>)
    <span class="variable">r</span>.<span class="variable">render</span>(<span class="variable">getViewUrl</span>(<span class="variable">modulename</span>, <span class="variable">viewname</span>), <span class="variable">mode</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">doc</span>) {
        <span class="variable">console</span>.<span class="variable">timeEnd</span>(<span class="string">'render'</span>);
        <span class="variable">res</span>.<span class="variable">end</span>(<span class="variable">doc</span>);
        
    });
}


<span class="keyword">const</span> <span class="class">DEFAULT_VIEW</span> = <span class="string">'main.html'</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets an absolute file URL of a module. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  moduleId unique module id</p></li><li><p><strong>param</strong>: <em>String</em>  viewname view name, may be a partial path</p></li><li><p><strong>return</strong>: <em>String</em> </p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getViewUrl</span>(<span class="variable">moduleid</span>, <span class="variable">viewname</span>) {
    <span class="keyword">return</span> <span class="string">'file://'</span> + <span class="variable">require</span>(<span class="string">'path'</span>)
            .<span class="variable">join</span>(<span class="variable">__dirname</span>
                    , <span class="string">'..'</span>
                    , <span class="string">'modules'</span>
                    , <span class="variable">moduleid</span>
                    , <span class="string">'htdocs'</span>
                    , <span class="variable">viewname</span> ? <span class="variable">viewname</span> : <span class="class">DEFAULT_VIEW</span>
            );
}   

<span class="comment">// [TBD] will ask the module factory</span>
<span class="keyword">function</span> <span class="variable">getModule</span> (<span class="variable">modulename</span>) {
    <span class="keyword">return</span> <span class="variable">true</span>;
}

<span class="variable">exports</span>.<span class="variable">handleControllerRequest</span> = <span class="variable">handleControllerRequest</span>;
<span class="variable">exports</span>.<span class="variable">handleScriptRequest</span>     = <span class="variable">handleScriptRequest</span>;
<span class="variable">exports</span>.<span class="variable">handleViewRequest</span>       = <span class="variable">handleViewRequest</span>;
<span class="variable">exports</span>.<span class="variable">configure</span>               = <span class="variable">configure</span>;
<span class="variable">exports</span>.<span class="variable">getViewUrl</span>              = <span class="variable">getViewUrl</span>;
<span class="variable">exports</span>.<span class="variable">getModule</span>               = <span class="variable">getModule</span>;</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/redisclient.js"><a href="#">redisclient</a></h2></td><td>../lib/redisclient.js</td></tr><tr class="code">
<td class="docs">
<p>Manages the connection to redis db.<br></br> </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">redback</span> = <span class="variable">require</span>(<span class="string">'redback'</span>)
    , <span class="variable">redbackClient</span> = <span class="variable">redback</span>.<span class="variable">createClient</span>()
	
<span class="comment">//cache = redbackClient.createCache('softporn');</span>
<span class="comment">//console.log(require('sys').inspect(redbackClient));</span>
<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'redis client started'</span>);

<span class="keyword">var</span> <span class="variable">channel</span> = <span class="variable">redbackClient</span>.<span class="variable">createChannel</span>(<span class="variable">redbackClient</span>);

<span class="variable">channel</span>.<span class="variable">publish</span>(<span class="string">'foobar'</span>, <span class="keyword">function</span> () {
	<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'published'</span>);
});

<span class="variable">channel</span>.<span class="variable">subscribe</span>(<span class="string">'foobar'</span>, <span class="keyword">function</span> (<span class="variable">data</span>) {
	<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'received '</span> + <span class="variable">data</span>)
})

<span class="variable">channel</span>.<span class="variable">on</span>(<span class="string">'message'</span>, <span class="keyword">function</span> (<span class="variable">msg</span>) {
	<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'message!! '</span> + <span class="variable">msg</span>);
            <span class="comment">// assert.equal('foo', msg);</span>
            <span class="comment">// if (msg != 'foo') {</span>
            <span class="comment">//     assert.ok(false);</span>
            <span class="comment">// }</span>
            <span class="comment">// received = true;</span>
        });</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/renderer.js"><a href="#">renderer</a></h2></td><td>../lib/renderer.js</td></tr><tr class="code">
<td class="docs">
<p>Here da magic. 
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">mod_xml</span>                 = <span class="variable">require</span>(<span class="string">'node-xml'</span>)
    , <span class="variable">mod_promise</span>           = <span class="variable">require</span>(<span class="string">'promised-io'</span>)
    , <span class="variable">sys</span>                   = <span class="variable">require</span>(<span class="string">'sys'</span>)
    , <span class="variable">logger</span>                = <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'TagManager'</span>)
    , <span class="variable">mod_tagmanager</span>        = <span class="variable">require</span>(<span class="string">'./tagmanager.js'</span>)
    , <span class="variable">mod_resourcemanager</span>   = <span class="variable">require</span>(<span class="string">'./resourcemanager.js'</span>)
    , <span class="variable">mod_resources</span>         = <span class="variable">require</span>(<span class="string">'./resources.js'</span>)
    , <span class="variable">mod_path</span>              = <span class="variable">require</span>(<span class="string">'path'</span>)
    , <span class="variable">mod_modules</span>           = <span class="variable">require</span>(<span class="string">'./modules.js'</span>)    

    , <span class="variable">c</span>     = <span class="variable">console</span>.<span class="variable">log</span>
    , <span class="variable">i</span>     = <span class="variable">sys</span>.<span class="variable">inspect</span>
    , <span class="variable">mr</span>    = <span class="keyword">function</span> () { <span class="keyword">return</span> <span class="class">Math</span>.<span class="variable">random</span>()*<span class="number integer">0</span>; }

<span class="keyword">function</span> <span class="class">Renderer</span>(<span class="variable">tagmgr</span>) {
    <span class="keyword">if</span> (!<span class="variable">tagmgr</span>) { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'tagmanager required'</span>); }
    <span class="this">this</span>.<span class="variable">tagmanager</span> = <span class="variable">tagmgr</span>
    <span class="this">this</span>.<span class="variable">renderResources</span> = [];
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The main workhorse function. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  View template absolute file:// URL </p></li><li><p><strong>param</strong>: <em>String</em>  Render mode, 'json' or 'html'</p></li><li><p><strong>returns</strong>: <em>Promise</em> </p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Renderer</span>.<span class="variable">prototype</span>.<span class="variable">render</span> = <span class="keyword">function</span> (<span class="variable">url</span>, <span class="variable">mode</span>) {
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">_render</span>(<span class="variable">url</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">renderres</span>) {
       <span class="variable">c</span>(<span class="variable">self</span>.<span class="variable">renderResources</span>.<span class="variable">length</span>);
        <span class="keyword">var</span> <span class="variable">deps</span> = <span class="variable">self</span>.<span class="variable">calcDependencies</span>(<span class="variable">renderres</span>)
            , <span class="variable">out</span> = <span class="variable">self</span>[<span class="variable">mode</span>!==<span class="string">'json'</span> ? <span class="string">'outputHtml'</span> : <span class="string">'outputJson'</span>](<span class="variable">renderres</span>, <span class="variable">deps</span>.<span class="variable">css</span>, <span class="variable">deps</span>.<span class="variable">scripts</span>, <span class="variable">deps</span>.<span class="variable">locales</span>);
        <span class="keyword">return</span> <span class="variable">out</span>;
    } );
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p> </p>
</td>
<td class="code">
<pre><code><span class="class">Renderer</span>.<span class="variable">prototype</span>.<span class="variable">calcDependencies</span> = <span class="keyword">function</span> (<span class="variable">renderres</span>) {        
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>
        , <span class="variable">css</span> = []
        , <span class="variable">scripts</span> = []
        , <span class="variable">locales</span> = []
        , <span class="variable">regex</span> = <span class="keyword">new</span> <span class="class">RegExp</span>(<span class="string">'file://'</span> + <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">__dirname</span>, <span class="string">'..'</span>));

        <span class="this">this</span>.<span class="variable">renderResources</span>.<span class="variable">reverse</span>().<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">dep</span>) {    
            <span class="variable">c</span>(<span class="string">'................... '</span> + <span class="variable">dep</span>.<span class="variable">url</span>)
            <span class="variable">path</span> = <span class="variable">dep</span>.<span class="variable">url</span>.<span class="variable">replace</span>(<span class="variable">regex</span>, &<span class="variable">quot</span>;&<span class="variable">quot</span>;)
                          .<span class="variable">replace</span>(<span class="regexp">/htdocs.*$/</span>, <span class="string">''</span>);
            <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">push</span>.<span class="variable">apply</span>(<span class="variable">css</span>, <span class="variable">dep</span>.<span class="variable">cssdeps</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                <span class="keyword">return</span> <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">path</span>, <span class="variable">item</span>);
            }));
            <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">push</span>.<span class="variable">apply</span>(<span class="variable">scripts</span>, <span class="variable">dep</span>.<span class="variable">scriptdeps</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                <span class="keyword">return</span> <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">path</span>,  <span class="variable">item</span>);
            }));
            <span class="class">Array</span>.<span class="variable">prototype</span>.<span class="variable">push</span>.<span class="variable">apply</span>(<span class="variable">locales</span>, <span class="variable">dep</span>.<span class="variable">localedeps</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                <span class="keyword">return</span> <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">path</span>,  <span class="string">'i18n'</span>, <span class="variable">item</span>);
            }));
        });

        <span class="this">this</span>.<span class="variable">renderResources</span>.<span class="variable">reverse</span>().<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">dep</span>) {
            <span class="variable">c</span>(<span class="variable">dep</span>.<span class="variable">url</span>);
        });

        <span class="keyword">return</span> { <span class="string">'css'</span> : <span class="variable">css</span>, <span class="string">'scripts'</span> : <span class="variable">scripts</span>, <span class="string">'locales'</span> : <span class="variable">locales</span> };
    }

<span class="comment">// [TBD] domain of ResourceService</span>
<span class="keyword">const</span> <span class="class">RESOURCE_LOADER_URLPATH</span> = &<span class="variable">quot</span>;/<span class="variable">resources</span>?<span class="variable">files</span>&<span class="variable">quot</span>;;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Transforms a RenderResource into HTML output format. 
This includes all dependencies of a view that are rendered into the output by using 
require.js function calls to have additional dependencies loaded by the web client. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Resource</em>  resource RenderedViewResource</p></li><li><p><strong>param</strong>: <em>String[]</em>  css URL to CSS dependency</p></li><li><p><strong>param</strong>: <em>String[]</em>  scripts URL to JavaScript dependency</p></li><li><p><strong>param</strong>: <em>String[]</em>  locales URL to locale dependency</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Renderer</span>.<span class="variable">prototype</span>.<span class="variable">outputHtml</span> = <span class="keyword">function</span> (<span class="variable">resource</span>, <span class="variable">css</span>, <span class="variable">scripts</span>, <span class="variable">locales</span>) {
    <span class="keyword">var</span> <span class="variable">doc</span> = <span class="variable">resource</span>.<span class="variable">data</span>.<span class="variable">toString</span>();

    <span class="keyword">var</span> <span class="variable">markup</span> = [];
    
    <span class="comment">// add CSS required by requested view</span>
    <span class="comment">// [TBD] the resource service should know how to create links to it, not this module. </span>
    <span class="keyword">if</span> (<span class="variable">css</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">css</span>.<span class="variable">length</span>) {
      <span class="variable">markup</span>.<span class="variable">push</span>(<span class="string">'&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;'</span>
                  , <span class="class">RESOURCE_LOADER_URLPATH</span>, <span class="string">'='</span>,<span class="variable">css</span>.<span class="variable">join</span>(<span class="string">';'</span>), <span class="string">'&quot;/&gt;\n'</span>); 
    }
    <span class="comment">// add JavaScript required by requested view</span>
    <span class="comment">// [TBD] the resource service should know how to create links to it, not this module. </span>
    <span class="keyword">if</span> (<span class="variable">scripts</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">scripts</span>.<span class="variable">length</span>) {
      <span class="variable">markup</span>.<span class="variable">push</span>(<span class="string">'&lt;script type=&quot;application/javascript&quot; src=&quot;'</span>, <span class="class">RESOURCE_LOADER_URLPATH</span>, <span class="string">'='</span>
                  , <span class="variable">scripts</span>.<span class="variable">join</span>(<span class="string">';'</span>), <span class="string">'&quot;&gt;&lt;/script&gt;\n'</span>);
    }

    <span class="variable">locales</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">locale</span>) {
        <span class="variable">c</span>(<span class="string">'l '</span> + <span class="variable">locale</span>);
    });

    <span class="keyword">if</span> (<span class="variable">resource</span>.<span class="variable">elements</span>.<span class="variable">length</span> &<span class="variable">gt</span>; <span class="number integer">0</span>) {
        <span class="variable">markup</span>.<span class="variable">push</span>(<span class="string">'\n&lt;script type=&quot;application/javascript&quot;&gt;\n'</span>);

        <span class="comment">// this.renderResources.reverse().forEach(function (dep) { </span>
        <span class="comment">//     markup.push('console.log(&quot;'+dep.url+'&quot;);');</span>
        <span class="comment">// });</span>
        <span class="variable">resource</span>.<span class="variable">elements</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">elem</span>) {
            <span class="keyword">var</span> <span class="variable">im</span> = <span class="variable">elem</span>.<span class="variable">instanceId</span> ? <span class="string">',&quot;text!/instances/'</span> + <span class="variable">elem</span>.<span class="variable">instanceId</span> + <span class="string">'.js&quot;'</span> : <span class="string">''</span>;
            <span class="keyword">var</span> <span class="variable">l</span> = <span class="variable">elem</span>.<span class="variable">locale</span>
            <span class="variable">markup</span>.<span class="variable">push</span>(<span class="string">'\nrequire([&quot;/modules/'</span>, <span class="variable">elem</span>.<span class="variable">moduleId</span>, <span class="string">'/client.js&quot;'</span>
                          , <span class="string">', &quot;text!/modules/'</span>, <span class="variable">elem</span>.<span class="variable">moduleId</span>, <span class="string">'/main.html?type=json&quot;'</span>
                          , <span class="variable">im</span>
                          , <span class="string">', &quot;text!/modules/'</span>, <span class="variable">elem</span>.<span class="variable">moduleId</span>, <span class="string">'/locales/de_DE.xml&quot;'</span>
                          , <span class="string">'], '</span>
                          , <span class="string">' function (module, template, instance, localefile) { module.initView(&quot;'</span>
                          , <span class="variable">elem</span>.<span class="variable">id</span>, <span class="string">'&quot;, template, instance, localefile) } );'</span>
            );
        });
        <span class="variable">markup</span>.<span class="variable">push</span>(<span class="string">'\n&lt;/script&gt;\n'</span>);
    }
    
    <span class="comment">// this, erm, could be done more elegantly. but it frakking works for now ^^ </span>
    <span class="keyword">var</span> <span class="variable">idx</span> = <span class="variable">doc</span>.<span class="variable">indexOf</span>(<span class="string">'&lt;/head&gt;'</span>);
    <span class="variable">doc</span> = <span class="variable">doc</span>.<span class="variable">substring</span>(<span class="number integer">0</span>, <span class="variable">idx</span>) + <span class="variable">markup</span>.<span class="variable">join</span>(<span class="string">''</span>) + <span class="variable">doc</span>.<span class="variable">substring</span>(<span class="variable">idx</span>, <span class="variable">doc</span>.<span class="variable">length</span>);

    <span class="keyword">return</span> <span class="variable">doc</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Renders a resource as JSON. Currently mixes up partials and JSON output, which should not be the same. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>RenderedViewResource</em>  resource Resource to render</p></li><li><p><strong>param</strong>: <em>String[]</em>  css URL to CSS dependency</p></li><li><p><strong>param</strong>: <em>String[]</em>  scripts URL to JavaScript dependency</p></li><li><p><strong>param</strong>: <em>String[]</em>  locales URL to locale dependency </p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Renderer</span>.<span class="variable">prototype</span>.<span class="variable">outputJson</span> = <span class="keyword">function</span> (<span class="variable">resource</span>, <span class="variable">css</span>, <span class="variable">scripts</span>, <span class="variable">locales</span>) {
    <span class="keyword">var</span> <span class="variable">body</span> = <span class="variable">resource</span>.<span class="variable">data</span>.<span class="variable">toString</span>().<span class="variable">match</span>(<span class="regexp">/(&lt;body[^&gt;]*&gt;)([\s\S]*)(&lt;\/body</span>&<span class="variable">gt</span>;)/<span class="variable">mi</span>)[<span class="number integer">2</span>];
    <span class="keyword">var</span> <span class="variable">obj</span> = { 
      &<span class="variable">quot</span>;<span class="variable">resources</span>&<span class="variable">quot</span>; : {
        &<span class="variable">quot</span>;<span class="variable">css</span>&<span class="variable">quot</span>;       : <span class="variable">css</span>
        , &<span class="variable">quot</span>;<span class="variable">script</span>&<span class="variable">quot</span>;  : <span class="variable">scripts</span>
        , &<span class="variable">quot</span>;<span class="variable">locales</span>&<span class="variable">quot</span>; : <span class="variable">locales</span>
      }
      , &<span class="variable">quot</span>;<span class="variable">content</span>&<span class="variable">quot</span>; : <span class="variable">body</span>
    };
    <span class="keyword">return</span> <span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="variable">obj</span>);
}

<span class="class">Renderer</span>.<span class="variable">prototype</span>.<span class="variable">_render</span> = <span class="keyword">function</span> (<span class="variable">url</span>) {
    <span class="keyword">var</span> <span class="variable">p</span> = <span class="keyword">new</span> <span class="variable">mod_promise</span>.<span class="class">Promise</span>()
        , <span class="variable">self</span> = <span class="this">this</span>
    <span class="variable">c</span>(<span class="string">'render '</span> + <span class="variable">url</span>);

    <span class="variable">self</span>.<span class="variable">loadResource</span>(<span class="variable">url</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">resource</span>){
        <span class="keyword">if</span> (!<span class="variable">resource</span> <span class="variable">instanceof</span> <span class="variable">mod_resources</span>.<span class="class">Resource</span>) { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'wrong type'</span>); }
        <span class="variable">self</span>.<span class="variable">parse</span>(<span class="variable">resource</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">renderres</span>) { 
            <span class="keyword">if</span> (!<span class="variable">renderres</span> <span class="variable">instanceof</span> <span class="variable">mod_resources</span>.<span class="class">RenderedViewResource</span>) { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'wrong type'</span>); }
            <span class="variable">self</span>.<span class="variable">renderResources</span>.<span class="variable">push</span>(<span class="variable">renderres</span>);
            <span class="variable">c</span>(<span class="string">'pushing '</span> + <span class="variable">renderres</span>.<span class="variable">elements</span>)
            <span class="keyword">var</span> <span class="variable">r</span> = []
                , <span class="variable">depsdone</span> = {};
            <span class="keyword">if</span> (<span class="variable">renderres</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">renderres</span>.<span class="variable">elements</span>) {
                <span class="variable">renderres</span>.<span class="variable">elements</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                    <span class="keyword">debugger</span>;
                    <span class="keyword">if</span> (<span class="variable">mod_modules</span>.<span class="variable">getModule</span>(<span class="variable">item</span>.<span class="variable">moduleId</span>)) {
                        <span class="keyword">var</span> <span class="variable">viewurl</span> = <span class="variable">mod_modules</span>.<span class="variable">getViewUrl</span>(<span class="variable">item</span>.<span class="variable">moduleId</span>, <span class="string">'main.html'</span>);
                        <span class="keyword">if</span> (!<span class="variable">depsdone</span>[<span class="variable">viewurl</span>]) {
                            <span class="variable">r</span>.<span class="variable">push</span>(<span class="variable">self</span>.<span class="variable">_render</span>(<span class="variable">viewurl</span>));  
                        } <span class="keyword">else</span> { }
                        <span class="variable">depsdone</span>[<span class="variable">viewurl</span>] = <span class="variable">true</span>;
                    } <span class="keyword">else</span> {
                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'module not found'</span>);
                    }
                });
                <span class="variable">mod_promise</span>.<span class="variable">all</span>(<span class="variable">r</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">vals</span>) {
                    <span class="variable">c</span>(<span class="string">'resolved all sub-renders '</span> + <span class="variable">url</span>);
                    <span class="variable">p</span>.<span class="variable">resolve</span>(<span class="variable">renderres</span>);
                });
            } <span class="keyword">else</span> {
                <span class="variable">p</span>.<span class="variable">resolve</span>(<span class="variable">renderres</span>);
            }
        });
    });
    <span class="keyword">return</span> <span class="variable">p</span>;
}

<span class="class">Renderer</span>.<span class="variable">prototype</span>.<span class="variable">parse</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="keyword">return</span> <span class="variable">parseHtmlView</span>(<span class="variable">resource</span>, <span class="this">this</span>.<span class="variable">tagmanager</span>);
}

<span class="class">Renderer</span>.<span class="variable">prototype</span>.<span class="variable">loadResource</span> = <span class="keyword">function</span> (<span class="variable">url</span>) {
    <span class="keyword">return</span> <span class="variable">mod_resourcemanager</span>.<span class="variable">getResource</span>(<span class="variable">url</span>);
}

<span class="variable">exports</span>.<span class="class">Renderer</span> = <span class="class">Renderer</span>;

<span class="keyword">function</span> <span class="variable">parseHtmlView</span> (<span class="variable">resource</span>, <span class="variable">tagmanager</span>) {
    <span class="keyword">var</span> <span class="variable">defer</span>               = <span class="keyword">new</span> <span class="variable">mod_promise</span>.<span class="variable">defer</span>()
        , <span class="variable">url</span>               = <span class="variable">resource</span>.<span class="variable">url</span>
        , <span class="variable">parser</span>            = <span class="keyword">new</span> <span class="variable">mod_xml</span>.<span class="class">SaxParser</span>(<span class="keyword">new</span> <span class="class">DocParser</span>())

        <span class="comment">// these are filled by the parser and returned to the caller </span>
        , <span class="variable">elements</span>          = [] <span class="comment">// web components used by view, in parse order</span>
        , <span class="variable">outputBuffer</span>      = []
        , <span class="variable">cssresources</span>      = [] <span class="comment">// css resources used by view, in document order</span>
        , <span class="variable">scriptresources</span>   = [] <span class="comment">// javasript resources used by view, in document order</span>
        , <span class="variable">textresources</span>     = [] <span class="comment">// javasript resources used by view, in document order</span>

    <span class="variable">parser</span>.<span class="variable">parseString</span>(<span class="variable">resource</span>.<span class="variable">data</span>.<span class="variable">toString</span>());
    <span class="keyword">return</span> <span class="variable">defer</span>.<span class="variable">promise</span>;

    <span class="keyword">function</span> <span class="class">DocParser</span>() {
        <span class="keyword">var</span> <span class="variable">tagRemoved</span> = <span class="variable">false</span>;

        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="variable">cb</span>) {
            <span class="variable">cb</span>.<span class="variable">onStartDocument</span>(<span class="keyword">function</span>() {
                <span class="comment">//console.log('onStartDocument');  </span>
            });

            <span class="variable">cb</span>.<span class="variable">onEndDocument</span>(<span class="keyword">function</span>() {
                <span class="variable">console</span>.<span class="variable">log</span>(<span class="variable">elements</span>);
                <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="keyword">new</span> <span class="variable">mod_resources</span>.<span class="class">RenderedViewResource</span>(<span class="variable">url</span>
                                                                    , <span class="keyword">new</span> <span class="class">Buffer</span>(<span class="variable">outputBuffer</span>.<span class="variable">join</span>(<span class="string">''</span>))
                                                                    , <span class="variable">elements</span>
                                                                    , <span class="variable">cssresources</span>
                                                                    , <span class="variable">scriptresources</span>
                                                                    , <span class="variable">textresources</span>)
                );
            });

            <span class="variable">cb</span>.<span class="variable">onStartElementNS</span>(<span class="keyword">function</span>(<span class="variable">elem</span>, <span class="variable">attrs</span>, <span class="variable">prefix</span>, <span class="variable">uri</span>, <span class="variable">namespaces</span>) {
                <span class="comment">//sys.puts(&quot;=====&gt; Started: &quot; + elem + &quot; uri=&quot;+uri +&quot; (Attributes: &quot; + JSON.stringify(attrs) + &quot; )&quot;);</span>
                <span class="keyword">var</span> <span class="variable">instanceid</span>
                    , <span class="variable">viewname</span>

                <span class="comment">//</span>
                <span class="comment">// a document should not be transformed in parser. </span>
                <span class="comment">// reminder to refactor to new render transformer</span>
                <span class="comment">// </span>
                <span class="comment">//logger.debug(uri);</span>
                <span class="comment">// [TBD] should do namespace check</span>
                <span class="keyword">if</span> (<span class="variable">elem</span> === <span class="string">'link'</span>) {
                    <span class="variable">attrs</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                        <span class="keyword">if</span> (<span class="variable">item</span>[<span class="number integer">0</span>] === <span class="string">'href'</span>) {
                            <span class="variable">cssresources</span>.<span class="variable">push</span>(<span class="variable">item</span>[<span class="number integer">1</span>]);
                            <span class="variable">tagRemoved</span> = <span class="variable">true</span>;
                        }
                    });
                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">elem</span> == <span class="string">'script'</span>) {
                    <span class="variable">attrs</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                        <span class="keyword">if</span> (<span class="variable">item</span>[<span class="number integer">0</span>] === <span class="string">'src'</span>) {
                            <span class="variable">scriptresources</span>.<span class="variable">push</span>(<span class="variable">item</span>[<span class="number integer">1</span>]);
                            <span class="variable">tagRemoved</span> = <span class="variable">true</span>;
                        }
                    });
                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">elem</span> == <span class="string">'text'</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">prefix</span> === <span class="string">'tx'</span>) {
                    <span class="variable">attrs</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                        <span class="keyword">if</span> (<span class="variable">item</span>[<span class="number integer">0</span>] === <span class="string">'key'</span>) {
                            <span class="variable">textresources</span>.<span class="variable">push</span>(<span class="variable">item</span>[<span class="number integer">1</span>]);
                        }
                    });
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable">tag</span> = <span class="variable">tagmanager</span>.<span class="variable">getTag</span>(<span class="variable">elem</span>, <span class="variable">attrs</span>, <span class="variable">prefix</span>, <span class="variable">uri</span>, <span class="variable">namespaces</span>);
                    <span class="keyword">if</span> (<span class="variable">tag</span> !== <span class="keyword">null</span>) {
                        <span class="comment">//logger.debug('found tag ' + tag.selector);</span>
                        <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">attrs</span>.<span class="variable">length</span>; <span class="variable">i</span>++) {
                            <span class="keyword">if</span> (<span class="variable">attrs</span>[<span class="variable">i</span>][<span class="number integer">0</span>] === <span class="string">'instanceid'</span>) {
                                <span class="variable">instanceid</span> = <span class="variable">attrs</span>[<span class="variable">i</span>][<span class="number integer">1</span>];
                                <span class="keyword">break</span>;
                            }
                            <span class="keyword">if</span> (<span class="variable">attrs</span>[<span class="variable">i</span>][<span class="number integer">0</span>] === <span class="string">'view'</span>) {
                                <span class="variable">viewname</span> = <span class="variable">attrs</span>[<span class="variable">i</span>][<span class="number integer">1</span>];
                                <span class="keyword">break</span>;
                            }
                        }
                        <span class="keyword">var</span> <span class="variable">eid</span> = <span class="variable">addId</span>(<span class="variable">attrs</span>);
                        <span class="keyword">var</span> <span class="variable">elemResource</span> = {
                            <span class="string">'id'</span> : <span class="variable">eid</span> 
                            , <span class="string">'instanceId'</span>  : <span class="variable">instanceid</span>
                            , <span class="string">'moduleId'</span>    : <span class="variable">tag</span>.<span class="variable">module</span> 
                            , <span class="string">'view'</span>        : <span class="variable">viewname</span>
                        };
                        <span class="variable">elements</span>.<span class="variable">push</span>(<span class="variable">elemResource</span>);
                    }
                }

                <span class="keyword">if</span> (!<span class="variable">tagRemoved</span>) {
                    <span class="variable">outputBuffer</span> = <span class="variable">outputBuffer</span>.<span class="variable">concat</span>(<span class="variable">copyStartTag</span>(<span class="variable">elem</span>, <span class="variable">attrs</span>, <span class="variable">prefix</span>, <span class="variable">uri</span>, <span class="variable">namespaces</span>));
                }
                <span class="variable">addId</span>(<span class="variable">attrs</span>);
            });

            <span class="variable">cb</span>.<span class="variable">onEndElementNS</span>(<span class="keyword">function</span>(<span class="variable">elem</span>, <span class="variable">prefix</span>, <span class="variable">uri</span>) {
                <span class="keyword">if</span> (!<span class="variable">tagRemoved</span>) {
                    <span class="variable">outputBuffer</span>.<span class="variable">push</span>(&<span class="variable">quot</span>;&<span class="variable">lt</span>;/&<span class="variable">quot</span>;, (<span class="variable">prefix</span> ? <span class="variable">prefix</span> + &<span class="variable">quot</span>;:&<span class="variable">quot</span>; : &<span class="variable">quot</span>;&<span class="variable">quot</span>;), <span class="variable">elem</span>, &<span class="variable">quot</span>;&<span class="variable">gt</span>;&<span class="variable">quot</span>;);
                } <span class="keyword">else</span> { }
                <span class="variable">tagRemoved</span> = <span class="variable">false</span>;
            });

            <span class="variable">cb</span>.<span class="variable">onCharacters</span>(<span class="variable">copy</span>);
            <span class="variable">cb</span>.<span class="variable">onCdata</span>(<span class="variable">copy</span>);
            <span class="comment">//cb.onComment(copy);</span>

            <span class="keyword">function</span> <span class="variable">copy</span>(<span class="variable">chars</span>) {
                <span class="variable">outputBuffer</span>.<span class="variable">push</span>(<span class="variable">chars</span>);
            };

            <span class="variable">cb</span>.<span class="variable">onWarning</span>(<span class="keyword">function</span>(<span class="variable">msg</span>) {
                <span class="variable">logger</span>.<span class="variable">warn</span>(<span class="string">'warning '</span> + <span class="variable">msg</span>);
            });

            <span class="variable">cb</span>.<span class="variable">onError</span>(<span class="keyword">function</span>(<span class="variable">msg</span>) {
                <span class="variable">logger</span>.<span class="variable">error</span>(<span class="string">'&lt;ERROR&gt;'</span>+<span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="variable">msg</span>)+&<span class="variable">quot</span>;&<span class="variable">lt</span>;/<span class="class">ERROR</span>&<span class="variable">gt</span>;&<span class="variable">quot</span>;);
            });
        }
    }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>add an 'id' attribute to identify the element when inserting its rendered content</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>attributes[]</em>  attrs attributes from node-xml sax</p></li><li><p><strong>return</strong>: <em>String</em>  existing or new element id </p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">addId</span>(<span class="variable">attrs</span>) {
    <span class="keyword">var</span> <span class="variable">eid</span>
        <span class="comment">// [TBD] use fixed format so file sizes is guaranteed on equal input</span>
        , <span class="variable">elemId</span> = &<span class="variable">quot</span>;<span class="variable">module</span>&<span class="variable">quot</span>; + <span class="keyword">new</span> <span class="class">Date</span>().<span class="variable">getTime</span>() + &<span class="variable">quot</span>;&<span class="variable">quot</span>; + <span class="variable">parseInt</span>(<span class="class">Math</span>.<span class="variable">random</span>()*<span class="number integer">10</span>);
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">j</span> = <span class="number integer">0</span>, <span class="variable">al</span> = <span class="variable">attrs</span>.<span class="variable">length</span>, <span class="variable">hasId</span> = <span class="variable">false</span>; <span class="variable">j</span> &<span class="variable">lt</span>; <span class="variable">al</span>; <span class="variable">j</span>++) {
        <span class="keyword">if</span> (<span class="variable">attrs</span>[<span class="variable">j</span>][<span class="number integer">0</span>] === &<span class="variable">quot</span>;<span class="variable">id</span>&<span class="variable">quot</span>;) {
            <span class="variable">eid</span> = <span class="variable">attrs</span>[<span class="variable">j</span>][<span class="number integer">1</span>];
            <span class="variable">hasId</span> = <span class="variable">true</span>;
        }
    }
    <span class="keyword">if</span> (!<span class="variable">hasId</span>) {
        <span class="variable">attrs</span>.<span class="variable">push</span>([&<span class="variable">quot</span>;<span class="variable">id</span>&<span class="variable">quot</span>;, <span class="variable">elemId</span>]);
        <span class="keyword">return</span> <span class="variable">elemId</span>
    } <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="variable">eid</span>;
    }
}

<span class="keyword">function</span> <span class="variable">copyStartTag</span>(<span class="variable">elem</span>, <span class="variable">attrs</span>, <span class="variable">prefix</span>, <span class="variable">uri</span>, <span class="variable">namespaces</span>) {
    <span class="keyword">var</span> <span class="variable">outputBuffer</span> = [];
    <span class="variable">outputBuffer</span>.<span class="variable">push</span>(&<span class="variable">quot</span>;&<span class="variable">lt</span>;&<span class="variable">quot</span>;, (<span class="variable">prefix</span> ? <span class="variable">prefix</span> + &<span class="variable">quot</span>;:&<span class="variable">quot</span>; : &<span class="variable">quot</span>;&<span class="variable">quot</span>;), <span class="variable">elem</span>);
    <span class="keyword">if</span> (<span class="variable">namespaces</span>.<span class="variable">length</span> &<span class="variable">gt</span>; <span class="number integer">0</span> || <span class="variable">attrs</span>.<span class="variable">length</span> &<span class="variable">gt</span>; <span class="number integer">0</span>) {
        <span class="variable">outputBuffer</span>.<span class="variable">push</span>(&<span class="variable">quot</span>; &<span class="variable">quot</span>;);
    }
    <span class="comment">//for (i = 0; i &lt; namespaces.length; i++) {</span>
    <span class="comment">//    outputBuffer.push(&quot;xmlns:&quot; + namespaces[i][0] + &quot;=\&quot;&quot; + namespaces[i][1] + &quot;\&quot; &quot;);</span>
    <span class="comment">//    savedNamespaces[namespaces[i][1]] = namespaces[i][0]; </span>
    <span class="comment">//}</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">attrs</span>.<span class="variable">length</span>; <span class="variable">i</span>++) {
        <span class="variable">outputBuffer</span>.<span class="variable">push</span>(<span class="variable">attrs</span>[<span class="variable">i</span>][<span class="number integer">0</span>], <span class="string">'=&quot;'</span>, <span class="variable">attrs</span>[<span class="variable">i</span>][<span class="number integer">1</span>], <span class="string">'&quot;'</span>);
        <span class="keyword">if</span> (<span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">attrs</span>.<span class="variable">length</span> - <span class="number integer">1</span>) { 
            <span class="variable">outputBuffer</span>.<span class="variable">push</span>(<span class="string">' '</span>); 
        }
    }
    <span class="variable">outputBuffer</span>.<span class="variable">push</span>([<span class="string">'meta'</span>, <span class="string">'link'</span>, <span class="string">'br'</span>, <span class="string">'img'</span>, <span class="string">'input'</span>].<span class="variable">indexOf</span>(<span class="variable">elem</span>) &<span class="variable">gt</span>; -<span class="number integer">1</span> ? <span class="string">'/&gt;'</span> : <span class="string">'&gt;'</span>);
    <span class="keyword">return</span> <span class="variable">outputBuffer</span>;
}</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/resourcemanager.js"><a href="#">resourcemanager</a></h2></td><td>../lib/resourcemanager.js</td></tr><tr class="code">
<td class="docs">
<p>Resources are normally not constructed manually but accessed using this module. 
If caching is enabled, the Resource Manager takes care of caching. </p>

<h2>Todos</h2>

<ul><li>Resource Resolution </li><li>Define schemes and transitions: </li><li>External HTTP URLs --&gt; Routed URLS --&gt; Module-internal URLs --&gt; File system URLs; vice versa</li><li>Module-specific URIs, e.g. module://weather;1.0.1 maps to [determined by global web component broker]</li><li>Need clear borders between sub-components for all URL schemes</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">resources</span>           = <span class="variable">require</span>(<span class="string">'./resources.js'</span>)
    , <span class="variable">mod_events</span>        = <span class="variable">require</span>(<span class="string">'events'</span>)
    , <span class="variable">mod_resources</span>     = <span class="variable">require</span>(<span class="string">'./resources.js'</span>)
    , <span class="variable">mod_promise</span>       = <span class="variable">require</span>(<span class="string">'promised-io'</span>)
    , <span class="variable">mod_path</span>          = <span class="variable">require</span>(<span class="string">'path'</span>)
    , <span class="variable">mod_sys</span>           = <span class="variable">require</span>(<span class="string">'sys'</span>)
    , <span class="variable">logger</span>            = <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'ResourceManager'</span>)
    , <span class="variable">config</span>            = <span class="keyword">null</span>
    , <span class="variable">cache</span>             = <span class="keyword">null</span>
    , <span class="variable">c</span>                 = <span class="variable">console</span>.<span class="variable">log</span>

<span class="comment">// we are in ./lib, document root is always one up</span>
<span class="keyword">const</span> <span class="variable">documentRoot</span>      = <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">__dirname</span>, <span class="string">'..'</span>);

<span class="keyword">function</span> <span class="variable">configure</span>(<span class="variable">c</span>, <span class="variable">ch</span>) {
    <span class="variable">config</span> = <span class="variable">c</span>;
    <span class="variable">cache</span> = <span class="variable">ch</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Convenience array style version of getResource </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String[]</em>  urls URL to resource</p></li><li><p><strong>return</strong>: <em>Promise</em>  Promise, is resolved once all resources are loaded</p></li><li><p><strong>publi</strong>: <em>c</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getResources</span>(<span class="variable">urls</span>) {
    <span class="keyword">var</span> <span class="variable">defer</span> = <span class="variable">mod_promise</span>.<span class="variable">defer</span>();
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
    <span class="keyword">var</span> <span class="variable">u</span> = 
    <span class="variable">mod_promise</span>.<span class="variable">all</span>(<span class="variable">urls</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">item</span>) {
                        <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">getResource</span>(<span class="variable">item</span>);
                    }))
                    .<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">all</span>) {
                        <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="variable">all</span>);
                    });
    <span class="keyword">return</span> <span class="variable">defer</span>.<span class="variable">promise</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Loads a resource from either a file://, http:// or relative path. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  url file:// or http:// URL</p></li><li><p><strong>return</strong>: <em>Promise</em>  Promise, is resolved when resource is ready</p></li><li><p><strong>publi</strong>: <em>c</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getResource</span> (<span class="variable">url</span>) {
    <span class="keyword">return</span> <span class="variable">loadUrl</span>(<span class="variable">url</span>);
    <span class="comment">// var defer = mod_promise.defer();</span>
    <span class="comment">// loadUrl(url).then(function (res) {</span>
    <span class="comment">//     defer.resolve(res);</span>
    <span class="comment">// });</span>
    <span class="comment">// return defer.promise;</span>
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets a resource either from the cache (if enabled) or loads it. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  url resource url</p></li><li><p><strong>param</strong>: <em>Promise</em>  Promise, resolves to resource</p></li><li><p><strong>publi</strong>: <em>c</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">loadUrl</span>(<span class="variable">url</span>) {
    <span class="keyword">var</span> <span class="variable">defer</span> = <span class="variable">mod_promise</span>.<span class="variable">defer</span>()
        , <span class="variable">type</span> = <span class="keyword">null</span>
        , <span class="variable">resource</span> = <span class="keyword">null</span>

    <span class="keyword">if</span> (<span class="variable">cache</span>) {
        <span class="variable">cache</span>.<span class="variable">fromCache</span>(<span class="variable">url</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
        <span class="keyword">if</span> (!<span class="variable">resource</span>) {
            <span class="variable">resource</span> = <span class="variable">getResourceByUrl</span>(<span class="variable">url</span>)
                    .<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
                        <span class="variable">cache</span>.<span class="variable">toCache</span>(<span class="variable">url</span>, <span class="variable">resource</span>.<span class="variable">data</span>);
                        <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="variable">resource</span>);
                    });
        } <span class="keyword">else</span> {
            <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="variable">resource</span>);
        }
        });        
    } <span class="keyword">else</span> {
        <span class="variable">resource</span> = <span class="variable">getResourceByUrl</span>(<span class="variable">url</span>)
                    .<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
                        <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="variable">resource</span>);
                    });
    }

    
    <span class="keyword">return</span> <span class="variable">defer</span>.<span class="variable">promise</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Gets the correct resource type assiocated to a URL without querying the cache. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  url resource URL</p></li><li><p><strong>param</strong>: <em>Promise</em>  promise, resolves to resource instance. </p></li><li><p><strong>publi</strong>: <em>c</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getResourceByUrl</span>(<span class="variable">url</span>) {
    <span class="keyword">var</span> <span class="variable">defer</span>       = <span class="variable">mod_promise</span>.<span class="variable">defer</span>()
        , <span class="variable">resource</span>  = <span class="keyword">null</span>
        , <span class="variable">intUrl</span>    = <span class="variable">url</span>
    
    <span class="keyword">if</span> (<span class="variable">url</span>.<span class="variable">indexOf</span>(<span class="string">'http://'</span>) === <span class="number integer">0</span>) {                         
        <span class="variable">resource</span> = <span class="keyword">new</span> <span class="variable">mod_resources</span>.<span class="class">HttpResource</span>();
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">url</span>.<span class="variable">indexOf</span>(<span class="string">'file://'</span>) === <span class="number integer">0</span>) {
        <span class="variable">resource</span> = <span class="keyword">new</span> <span class="variable">mod_resources</span>.<span class="class">FileResource</span>();
    } <span class="keyword">else</span> {                                                    <span class="comment">// assume it's a file location</span>
        <span class="variable">intUrl</span> = <span class="variable">translatePathToFileUrl</span>(<span class="variable">url</span>);
        <span class="variable">resource</span> = <span class="keyword">new</span> <span class="variable">mod_resources</span>.<span class="class">FileResource</span>();
    }
    <span class="comment">//c('getResourceByUrl ' + url + (url != intUrl ? url : ''))</span>
    <span class="variable">resource</span>.<span class="variable">load</span>(<span class="variable">intUrl</span>);
    <span class="variable">resource</span>.<span class="variable">addListener</span>(<span class="string">'stateChanged'</span>, <span class="keyword">function</span> () {
        <span class="variable">defer</span>.<span class="variable">resolve</span>(<span class="variable">resource</span>);         
    });  
        
    <span class="keyword">return</span> <span class="variable">defer</span>.<span class="variable">promise</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Map a standard file path to a absolute file:// URL. Paths are always assumed relative to an
installation root folder.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  path file path</p></li><li><p><strong>param</strong>: <em>String</em>  an absolute file:// URL</p></li><li><p><strong>publi</strong>: <em>c</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">translatePathToFileUrl</span>(<span class="variable">path</span>) {
    <span class="keyword">var</span> <span class="variable">p</span> = <span class="string">'file://'</span>+ <span class="variable">mod_path</span>.<span class="variable">join</span>(<span class="variable">documentRoot</span>, <span class="variable">path</span>);
    <span class="keyword">return</span> <span class="variable">p</span>;
}

<span class="variable">exports</span>.<span class="variable">getResources</span>            = <span class="variable">getResources</span>;
<span class="variable">exports</span>.<span class="variable">getResource</span>             = <span class="variable">getResource</span>;
<span class="variable">exports</span>.<span class="variable">configure</span>               = <span class="variable">configure</span>;
<span class="variable">exports</span>.<span class="variable">translatePathToFileUrl</span>  = <span class="variable">translatePathToFileUrl</span>;</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/resources.js"><a href="#">resources</a></h2></td><td>../lib/resources.js</td></tr><tr class="code">
<td class="docs">
<p>Everything is a resource.</p>

<h2>Todos</h2>

<ul><li>Resources should be sealed and/or frozen after loading (state 'complete') </li></ul>

<h2></h2>

<ul><li><p><strong>type</strong>: <em>String</em> </p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">logger</span>          = <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'Resource'</span>)
    , <span class="variable">mod_util</span>      = <span class="variable">require</span>(<span class="string">'util'</span>)
    , <span class="variable">mod_events</span>    = <span class="variable">require</span>(<span class="string">'events'</span>)
    , <span class="variable">mod_http</span>      = <span class="variable">require</span>(<span class="string">'http'</span>)
    , <span class="variable">mod_fs</span>        = <span class="variable">require</span>(<span class="string">'fs'</span>)
    , <span class="variable">mod_url</span>       = <span class="variable">require</span>(<span class="string">'url'</span>)

<span class="keyword">function</span> <span class="variable">uuid</span>() {
    <span class="keyword">return</span> <span class="keyword">new</span> <span class="class">Date</span>().<span class="variable">getTime</span>() + <span class="string">'-'</span> + <span class="class">Math</span>.<span class="variable">round</span>(<span class="class">Math</span>.<span class="variable">random</span>()*<span class="number integer">10000</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<ul><li><p><strong>class</strong>: <em>Base</em>
resource class
## </p></li><li><p><strong>param</strong>: <em>String</em>  URL of resource</p></li><li><p><strong>param</strong>: <em>String</em>  resource payload </p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Resource</span>(<span class="variable">url</span>, <span class="variable">data</span>) {
    <span class="this">this</span>.<span class="variable">_state</span> = <span class="class">Resource</span>.<span class="class">STATE</span>.<span class="class">INIT</span>;
    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">url</span> !== <span class="string">'undefined'</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="keyword">typeof</span> <span class="variable">data</span> !== <span class="string">'undefined'</span>) {
        <span class="this">this</span>.<span class="variable">url</span> = <span class="variable">url</span>;
        <span class="this">this</span>.<span class="variable">data</span> = <span class="keyword">new</span> <span class="class">Buffer</span>(<span class="variable">data</span>);
        <span class="this">this</span>.<span class="variable">_state</span> = <span class="class">Resource</span>.<span class="class">STATE</span>.<span class="class">READY</span>;
    } <span class="keyword">else</span> {
        <span class="this">this</span>.<span class="variable">data</span> = <span class="keyword">null</span>;        
    }
    
    <span class="this">this</span>.<span class="variable">uuid</span> = <span class="variable">uuid</span>();
};
<span class="variable">mod_util</span>.<span class="variable">inherits</span>(<span class="class">Resource</span>, <span class="variable">mod_events</span>.<span class="class">EventEmitter</span>);

<span class="class">Object</span>.<span class="variable">defineProperty</span>(<span class="class">Resource</span>.<span class="variable">prototype</span>, <span class="string">'state'</span>, {
    <span class="variable">get</span> : <span class="keyword">function</span> () {
        <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">_state</span>;
    },
    <span class="variable">set</span> : <span class="keyword">function</span> (<span class="variable">val</span>) {
        <span class="keyword">if</span> (<span class="string">'number'</span> !== <span class="keyword">typeof</span> <span class="variable">val</span>) <span class="keyword">throw</span> <span class="class">Error</span>(<span class="string">'number expected, got '</span> + <span class="variable">val</span>);
        <span class="keyword">if</span> (<span class="variable">val</span> !== <span class="this">this</span>.<span class="variable">_state</span>) {
            <span class="this">this</span>.<span class="variable">_state</span> = <span class="variable">val</span>;
            <span class="this">this</span>.<span class="variable">emit</span>(<span class="string">'stateChanged'</span>, <span class="this">this</span>);
        }
    }
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Add a resource as a dependency to this resource. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Resource</em>  res</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Resource</span>.<span class="variable">prototype</span>.<span class="variable">addDependency</span> = <span class="keyword">function</span> (<span class="variable">res</span>) {
    <span class="this">this</span>.<span class="variable">_requiredResources</span>[<span class="variable">res</span>.<span class="variable">uuid</span>] = <span class="variable">res</span>;
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
    <span class="variable">res</span>.<span class="variable">addListener</span>(<span class="string">'stateChanged'</span>, <span class="keyword">function</span> () { 
        <span class="comment">//logger.debug('state changed from sub ' + this.uuid);</span>
        <span class="variable">self</span>.<span class="variable">_onDepStateChange</span>.<span class="variable">call</span>(<span class="variable">self</span>, <span class="variable">res</span>);
    });
};

<span class="class">Resource</span>.<span class="variable">prototype</span>.<span class="variable">_onDepStateChange</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="comment">//logger.debug('_onDepStateChange from ' + resource.uuid + '@' + this.uuid);</span>
    <span class="keyword">var</span> <span class="variable">state</span> = <span class="class">Resource</span>.<span class="class">STATE</span>.<span class="class">READY</span>;
    <span class="keyword">for</span> (<span class="variable">rn</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">_requiredResources</span>) {
        <span class="variable">state</span> = <span class="class">Math</span>.<span class="variable">min</span>(<span class="this">this</span>.<span class="variable">_requiredResources</span>[<span class="variable">rn</span>].<span class="variable">state</span>, <span class="variable">state</span>);
    }
    <span class="this">this</span>.<span class="variable">state</span> = <span class="variable">state</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Must be implemented by subclasses.
 </p>
</td>
<td class="code">
<pre><code><span class="class">Resource</span>.<span class="variable">prototype</span>.<span class="variable">load</span> = <span class="keyword">function</span> () {
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'not implemented'</span>);
}

<span class="class">Resource</span>.<span class="class">STATE</span> = {
    <span class="class">INIT</span>        : <span class="number integer">0</span>
    , <span class="class">LOADING</span>     : <span class="number integer">2</span>
    , <span class="class">WAITING</span>     : <span class="number integer">4</span>
    , <span class="class">READY</span>       : <span class="number integer">6</span>
};

<span class="variable">exports</span>.<span class="class">Resource</span> = <span class="class">Resource</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<ul><li><strong>class</strong>: <em>FileResource</em></li></ul>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  file URL of resource</p></li><li><p><strong>param</strong>: <em>String</em>  resource payload </p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">FileResource</span>() {
    <span class="class">Resource</span>.<span class="variable">apply</span>(<span class="this">this</span>, <span class="variable">arguments</span>);
}
<span class="variable">mod_util</span>.<span class="variable">inherits</span>(<span class="class">FileResource</span>, <span class="class">Resource</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  file file URL of resource</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">FileResource</span>.<span class="variable">prototype</span>.<span class="variable">load</span> = <span class="keyword">function</span> (<span class="variable">file</span>) {
    <span class="keyword">if</span> (<span class="string">'undefined'</span> === <span class="keyword">typeof</span> <span class="variable">file</span> || <span class="variable">file</span>.<span class="variable">indexOf</span>(<span class="string">'file://'</span>) !== <span class="number integer">0</span>) { 
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'missing or faulty argument'</span>); 
    }
    <span class="this">this</span>.<span class="variable">url</span> = <span class="variable">file</span>;
    <span class="this">this</span>.<span class="variable">state</span> = <span class="class">Resource</span>.<span class="class">STATE</span>.<span class="class">LOADING</span>;
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>,
        <span class="variable">file</span> = <span class="variable">file</span>.<span class="variable">substring</span>(<span class="number integer">7</span>);
    <span class="variable">mod_fs</span>.<span class="variable">readFile</span>(<span class="variable">file</span>, <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">data</span>) {
        <span class="keyword">if</span> (<span class="variable">err</span>) { <span class="keyword">throw</span> <span class="variable">err</span>; }
        <span class="variable">self</span>.<span class="variable">data</span> = <span class="variable">data</span>;
        <span class="variable">self</span>.<span class="variable">state</span> = <span class="class">Resource</span>.<span class="class">STATE</span>.<span class="class">READY</span>;
    });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<ul><li><strong>class</strong>: <em>HttpResource</em></li></ul>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  http URL of resource</p></li><li><p><strong>param</strong>: <em>String</em>  resource payload </p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">HttpResource</span>() {
    <span class="class">Resource</span>.<span class="variable">apply</span>(<span class="this">this</span>);
}
<span class="variable">mod_util</span>.<span class="variable">inherits</span>(<span class="class">HttpResource</span>, <span class="class">Resource</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  url http URL of resource</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">HttpResource</span>.<span class="variable">prototype</span>.<span class="variable">load</span> =  <span class="keyword">function</span> (<span class="variable">url</span>) {
    <span class="keyword">if</span> (<span class="string">'undefined'</span> === <span class="keyword">typeof</span> <span class="variable">url</span> || <span class="variable">url</span>.<span class="variable">indexOf</span>(<span class="string">'http://'</span>) !== <span class="number integer">0</span>) { 
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'missing or faulty argument'</span>); 
    }
    <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>,
        <span class="variable">req</span>;
    <span class="this">this</span>.<span class="variable">url</span> = <span class="variable">url</span>;
    <span class="this">this</span>.<span class="variable">state</span> = <span class="class">Resource</span>.<span class="class">STATE</span>.<span class="class">LOADING</span>;
    <span class="this">this</span>.<span class="variable">content</span> = <span class="string">''</span>;
    <span class="this">this</span>.<span class="variable">_options</span> = <span class="variable">mod_url</span>.<span class="variable">parse</span>(<span class="variable">url</span>);
    
    <span class="variable">req</span> = <span class="variable">mod_http</span>.<span class="variable">get</span>(<span class="this">this</span>.<span class="variable">_options</span>, <span class="keyword">function</span> (<span class="variable">res</span>) {
        <span class="keyword">if</span> (<span class="variable">res</span>.<span class="variable">statusCode</span> &<span class="variable">gt</span>;= <span class="number integer">400</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">res</span>.<span class="variable">statusCode</span> &<span class="variable">lt</span>;= <span class="number integer">500</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'URL could not be loaded, code '</span> + <span class="variable">res</span>.<span class="variable">statusCode</span> 
                + <span class="string">', url '</span> + <span class="variable">self</span>.<span class="variable">_options</span>.<span class="variable">host</span> + <span class="string">':'</span> + <span class="variable">self</span>.<span class="variable">_options</span>.<span class="variable">port</span> + <span class="variable">self</span>.<span class="variable">_options</span>.<span class="variable">path</span>);
        }
        <span class="variable">res</span>.<span class="variable">on</span>(<span class="string">'data'</span>, <span class="keyword">function</span> (<span class="variable">data</span>) {
            <span class="variable">self</span>.<span class="variable">data</span> = <span class="variable">data</span>;
        });        
        <span class="variable">res</span>.<span class="variable">on</span>(<span class="string">'end'</span>, <span class="keyword">function</span> () {
            <span class="variable">self</span>.<span class="variable">state</span> = <span class="class">Resource</span>.<span class="class">STATE</span>.<span class="class">READY</span>;
        });
    });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<ul><li><strong>class</strong>: <em>HttpResource</em></li></ul>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  url http URL of view template resource</p></li><li><p><strong>param</strong>: <em>Buffer</em>  data</p></li><li><p><strong>param</strong>: <em>String[]</em>  cssdeps </p></li><li><p><strong>param</strong>: <em>String[]</em>  scriptdeps</p></li><li><p><strong>param</strong>: <em>String[]</em>  localdeps</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">RenderedViewResource</span>(<span class="variable">url</span>, <span class="variable">data</span>, <span class="variable">elements</span>, <span class="variable">cssdeps</span>, <span class="variable">scriptdeps</span>, <span class="variable">localedeps</span>) {
    <span class="class">Resource</span>.<span class="variable">call</span>(<span class="this">this</span>, <span class="variable">url</span>, <span class="variable">data</span>);
    <span class="this">this</span>.<span class="variable">elements</span> = <span class="variable">elements</span>;
    <span class="this">this</span>.<span class="variable">cssdeps</span> = <span class="variable">cssdeps</span>;
    <span class="this">this</span>.<span class="variable">scriptdeps</span> = <span class="variable">scriptdeps</span>;
    <span class="this">this</span>.<span class="variable">localedeps</span> = <span class="variable">localedeps</span>;
}


<span class="class">RenderedViewResource</span>.<span class="variable">prototype</span>.<span class="variable">toString</span> = <span class="keyword">function</span> () {
    <span class="variable">process</span>.<span class="variable">exit</span>();
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">url</span> + <span class="string">','</span> + <span class="this">this</span>.<span class="variable">cssdeps</span> + <span class="string">''</span> + <span class="this">this</span>.<span class="variable">scriptdeps</span> + <span class="string">','</span> + <span class="this">this</span>.<span class="variable">localedeps</span>;
}
<span class="variable">mod_util</span>.<span class="variable">inherits</span>(<span class="class">RenderedViewResource</span>, <span class="class">Resource</span>);

<span class="class">Resource</span>.<span class="variable">prototype</span>.<span class="variable">toString</span> = <span class="keyword">function</span> () {
    <span class="variable">process</span>.<span class="variable">exit</span>();
}

<span class="variable">exports</span>.<span class="class">FileResource</span> = <span class="class">FileResource</span>;
<span class="variable">exports</span>.<span class="class">HttpResource</span> = <span class="class">HttpResource</span>;
<span class="variable">exports</span>.<span class="class">RenderedViewResource</span> = <span class="class">RenderedViewResource</span>;</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/server.js"><a href="#">server</a></h2></td><td>../lib/server.js</td></tr><tr class="code">
<td class="docs">
<p>main server.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">mod_connect</span>         = <span class="variable">require</span>(<span class="string">'connect'</span>)
    , <span class="variable">mod_sys</span>               = <span class="variable">require</span>(<span class="string">'sys'</span>)
    , <span class="variable">mod_path</span>              = <span class="variable">require</span>(<span class="string">'path'</span>)
    , <span class="variable">mod_resourceservice</span>   = <span class="keyword">null</span>
    , <span class="variable">mod_resourcemanager</span>   = <span class="variable">require</span>(<span class="string">'./resourcemanager.js'</span>)
    , <span class="variable">mod_tagmanager</span>        = <span class="variable">require</span>(<span class="string">'./tagmanager.js'</span>)
    , <span class="variable">mod_cache</span>             = <span class="variable">require</span>(<span class="string">'./Cache.js'</span>)
    , <span class="variable">mod_socketio</span>          = <span class="variable">require</span>(<span class="string">'./socketio.js'</span>)   
    , <span class="variable">mod_modules</span>           = <span class="variable">require</span>(<span class="string">'./modules.js'</span>)
    , <span class="variable">mod_fs</span>                = <span class="variable">require</span>(<span class="string">'fs'</span>)
    , <span class="variable">cache</span>                 = <span class="keyword">null</span>
    , <span class="variable">logger</span>                = <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'Server'</span>)

<span class="keyword">if</span> (<span class="variable">process</span>.<span class="variable">argv</span>.<span class="variable">length</span> &<span class="variable">lt</span>; <span class="number integer">3</span>) {
    <span class="variable">logger</span>.<span class="variable">error</span>(<span class="string">'usage: ...'</span>);
    <span class="variable">process</span>.<span class="variable">exit</span>();
}

<span class="comment">// [TBD] handle arguments properly</span>
<span class="comment">// [TBD] dynamic config service </span>
<span class="keyword">var</span> <span class="variable">config</span> = <span class="keyword">null</span>;
<span class="variable">logger</span>.<span class="variable">info</span>(<span class="string">'reading config from '</span> + <span class="variable">process</span>.<span class="variable">argv</span>[<span class="number integer">2</span>]); 
<span class="variable">mod_fs</span>.<span class="variable">readFile</span>(<span class="variable">process</span>.<span class="variable">argv</span>[<span class="number integer">2</span>], <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">data</span>) {
    <span class="keyword">if</span> (<span class="variable">err</span>) {
        <span class="variable">logger</span>.<span class="variable">error</span>(<span class="string">'error reading configuration'</span>);
        <span class="variable">process</span>.<span class="variable">exit</span>();
    }
    <span class="variable">config</span> = <span class="class">JSON</span>.<span class="variable">parse</span>(<span class="variable">data</span>);
    <span class="variable">logger</span>.<span class="variable">info</span>(<span class="string">'config loaded'</span>);
    <span class="variable">mod_cache</span>.<span class="variable">configure</span>(<span class="variable">config</span>);
    <span class="variable">mod_resourcemanager</span>.<span class="variable">configure</span>(<span class="variable">config</span>, <span class="variable">mod_cache</span>);
    <span class="variable">mod_resourceservice</span> = <span class="variable">require</span>(<span class="string">'./resourceservice.js'</span>)(<span class="variable">config</span>, <span class="variable">mod_resourcemanager</span>);
    <span class="variable">mod_tagmanager</span>.<span class="variable">setTagList</span>(<span class="variable">config</span>.<span class="variable">taglib</span>);
    <span class="variable">mod_modules</span>.<span class="variable">configure</span>(<span class="variable">config</span>, <span class="variable">mod_tagmanager</span>);
    <span class="variable">createServer</span>(<span class="variable">config</span>);
});

<span class="keyword">function</span> <span class="variable">createServer</span>(<span class="variable">config</span>) {
    <span class="keyword">var</span> <span class="variable">server</span> = <span class="variable">mod_connect</span>.<span class="variable">createServer</span>(
        <span class="variable">mod_connect</span>.<span class="variable">favicon</span>()
        , <span class="variable">mod_connect</span>.<span class="variable">router</span>(<span class="keyword">function</span> (<span class="variable">app</span>) {
                <span class="variable">app</span>.<span class="variable">get</span>(<span class="regexp">/^\/modules</span>\<span class="regexp">/([^\.]*)\/</span>(.*\.<span class="variable">js</span>)$/,          <span class="variable">mod_modules</span>.<span class="variable">handleScriptRequest</span>);
                <span class="variable">app</span>.<span class="variable">get</span>(<span class="regexp">/^\/modules</span>\<span class="regexp">/([^\.]*)\/</span>(.*\.<span class="variable">html</span>)$/,        <span class="variable">mod_modules</span>.<span class="variable">handleViewRequest</span>);            
                <span class="variable">app</span>.<span class="variable">get</span>(<span class="regexp">/^\/modules</span>\<span class="regexp">/([^\.]*)\/controller</span>\<span class="regexp">/(.*)$/</span>,  <span class="variable">mod_modules</span>.<span class="variable">handleControllerRequest</span>);
                <span class="variable">app</span>.<span class="variable">get</span>(<span class="regexp">/^\/resources</span>(.*)$/,                        <span class="variable">mod_resourceservice</span>.<span class="variable">handleRequest</span>);
                <span class="comment">//app.get(/instances\/(.*)/,                          mod_instances.handleInstanceRequest);</span>
            }
        )
        , <span class="variable">mod_connect</span>.<span class="variable">static</span>(<span class="variable">config</span>.<span class="variable">server</span>.<span class="variable">documentRoot</span>)        
        , <span class="variable">mod_connect</span>.<span class="variable">logger</span>()            
    );
    
    <span class="comment">//var io = require('socket.io').listen(server);</span>
    <span class="comment">//mod_socketio.init(io);</span>
    <span class="variable">server</span>.<span class="variable">listen</span>(<span class="variable">config</span>.<span class="variable">server</span>.<span class="variable">port</span>);
}

<span class="comment">// process.on('SIGINT', function () {</span>
<span class="comment">//  process.exit();</span>
<span class="comment">// });</span></code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/resourceservice.js"><a href="#">resourceservice</a></h2></td><td>../lib/resourceservice.js</td></tr><tr class="code">
<td class="docs">
<p>The resource service, code name "cyclone", is a center piece of Rain. 
Clients can call it with a list of resources separated by semicolons, 
that are loaded and concatenated in the order of their occurence. 
Rain currently creates request markup to this service in the render process. </p>

<h2>Examples</h2>

<p>&lt;link rel="stylesheet" type="text/css" href="/resources?files=/modules/scrollabletable/main.css
;/modules/domains/main.css;/modules/weather/main.css;/modules/app/application.css
;/modules/app/jquery-ui/css/smoothness/jquery-ui-1.8.14.custom.css"/&gt; </p>

<p>&lt;script type="application/javascript" src="/resources?files=/modules/app/require-jquery.js
;/modules/app/jquery-ui/js/jquery-ui-1.8.14.custom.min.js
;/modules/app/js/socket.io/socket.io.js"&gt;&lt;/script&gt; </p>

<p>A file must follow some simple rules to be loadable by the resource service: </p>

<ul><li>For URLs, e.g. for background images, always use the url() notation, since the parsers won't recognize them otherwise.</li></ul>

<h2>Todos</h2>

<ul><li>refactor to use the resource manager</li><li>add error handling for files not found</li><li>rewrite URLs used url() in CSS files </li><li>connect to redis for caching</li><li>support for HTTP files</li><li>correct distinction between local and remote file by protocol </li><li><p>put the little fucker into its own worker</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">module</span>.<span class="variable">exports</span> = <span class="keyword">function</span> (<span class="variable">c</span>, <span class="variable">resmgr</span>) {

	<span class="keyword">var</span>  <span class="variable">mod_fs</span>		 		= <span class="variable">require</span>(<span class="string">'fs'</span>)
		, <span class="variable">mod_url</span>			= <span class="variable">require</span>(<span class="string">'url'</span>)
		, <span class="variable">mod_http</span>			= <span class="variable">require</span>(<span class="string">'http'</span>)
		, <span class="variable">mod_promise</span>		= <span class="variable">require</span>(<span class="string">'promised-io'</span>)
		, <span class="variable">mod_path</span>			= <span class="variable">require</span>(<span class="string">'path'</span>)
		, <span class="variable">mod_cssnormalizer</span> = <span class="variable">require</span>(<span class="string">'./cssnormalizer.js'</span>)
		, <span class="variable">logger</span>			= <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'ResourceService'</span>)
		, <span class="variable">config</span> 			= <span class="variable">c</span>
		, <span class="variable">resourceManager</span>   = <span class="variable">resmgr</span>

	<span class="keyword">if</span> (!<span class="variable">config</span> || !<span class="variable">resmgr</span>) { <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'dependencies missing'</span>); }</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<pre><code> * Handles resource requests, usually created by the render engine when scanning a template file.  
 * Resource requests are aggregated requests to CSS or JavaScript files, both can not be mixed
 * into a single request. The correct mime type is determined by the suffix of the first 
 * file.  
 * 
 * @param {request} req Request object
 * @param {response} res Response object 
 * @param {response} next Next connect middleware routing rule
 * @public
 </code></pre>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">handleRequest</span> (<span class="variable">req</span>, <span class="variable">res</span>, <span class="variable">next</span>) {
		<span class="keyword">var</span> <span class="variable">url</span> = <span class="variable">mod_url</span>.<span class="variable">parse</span>(<span class="variable">req</span>.<span class="variable">url</span>, <span class="variable">true</span>)
			, <span class="variable">files</span> = <span class="variable">url</span>.<span class="variable">query</span>.<span class="variable">files</span>.<span class="variable">indexOf</span>(<span class="string">';'</span>) === -<span class="number integer">1</span> 
				? [<span class="variable">url</span>.<span class="variable">query</span>.<span class="variable">files</span>] 
				: <span class="variable">url</span>.<span class="variable">query</span>.<span class="variable">files</span>.<span class="variable">split</span>(<span class="string">';'</span>)
			, <span class="variable">isCss</span> = <span class="variable">files</span>[<span class="number integer">0</span>].<span class="variable">lastIndexOf</span>(<span class="string">'.css'</span>) == <span class="variable">files</span>[<span class="number integer">0</span>].<span class="variable">length</span> - <span class="number integer">4</span>
			, <span class="variable">absFiles</span>;

		<span class="comment">// The config must be present for computing the absolute file path of a resource. </span>
		<span class="keyword">if</span> (!<span class="variable">config</span> || !<span class="variable">resourceManager</span>) {
			<span class="variable">logger</span>.<span class="variable">error</span>(<span class="string">'config not found'</span>);
			<span class="keyword">return</span>;
		}

		<span class="variable">files</span> = <span class="variable">files</span>.<span class="variable">map</span>(<span class="keyword">function</span> (<span class="variable">url</span>) {
			<span class="keyword">return</span> <span class="variable">config</span>.<span class="variable">server</span>.<span class="variable">serverRoot</span> + <span class="variable">url</span>.<span class="variable">replace</span>(<span class="keyword">new</span> <span class="class">RegExp</span>(&<span class="variable">quot</span>;^(<span class="regexp">/modules\/</span>[^\<span class="regexp">/]+)&quot;), &quot;$1/htdocs</span>/&<span class="variable">quot</span>;)
		})

		<span class="variable">resourceManager</span>.<span class="variable">getResources</span>(<span class="variable">files</span>).<span class="variable">then</span>(<span class="keyword">function</span> (<span class="variable">resources</span>) {
			<span class="keyword">var</span> <span class="variable">output</span> = [];
			<span class="variable">resources</span>.<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
				<span class="variable">output</span>.<span class="variable">push</span>(<span class="string">'\n\n\n\/\*\* FILE '</span>, <span class="variable">resource</span>.<span class="variable">url</span>, <span class="string">' */\n'</span>, <span class="variable">resource</span>.<span class="variable">data</span>.<span class="variable">toString</span>());
			});
			<span class="variable">res</span>.<span class="variable">end</span>(<span class="variable">output</span>.<span class="variable">join</span>(<span class="string">''</span>));
		});
	}

	<span class="keyword">return</span> {
		<span class="string">'handleRequest'</span> : <span class="variable">handleRequest</span>
	}
};</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/socketio.js"><a href="#">socketio</a></h2></td><td>../lib/socketio.js</td></tr><tr class="code">
<td class="docs">
<p>This does not work yet as the connection is lost on re-loading the server.
Client reload should go into the 'demon' script (to be build from the ashes of run.js)
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">init</span> (<span class="variable">io</span>) {
	<span class="variable">io</span>.<span class="variable">sockets</span>.<span class="variable">on</span>(<span class="string">'connection'</span>, <span class="keyword">function</span> (<span class="variable">socket</span>) {
		<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'client connected'</span>);
		<span class="variable">socket</span>.<span class="variable">on</span>(<span class="string">'rain.application.state'</span>, <span class="keyword">function</span> (<span class="variable">from</span>, <span class="variable">msg</span>) {
	    	<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'rain.application.state message'</span>, <span class="variable">from</span>, <span class="string">':'</span>, <span class="variable">msg</span>);
		});

		<span class="variable">socket</span>.<span class="variable">on</span>(<span class="string">'disconnect'</span>, <span class="keyword">function</span> () {
			<span class="variable">io</span>.<span class="variable">sockets</span>.<span class="variable">emit</span>(<span class="string">'user disconnected'</span>);
		});
	});
}

<span class="keyword">function</span> <span class="variable">send</span> (<span class="variable">io</span>) {
	<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'send reload request'</span>);
	<span class="variable">io</span>.<span class="variable">sockets</span>.<span class="variable">emit</span>(<span class="string">'rain.application.reload'</span>, { <span class="string">'reload'</span> : <span class="variable">true</span> } );
}

<span class="variable">exports</span>.<span class="variable">init</span> = <span class="variable">init</span>;</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/tagmanager.js"><a href="#">tagmanager</a></h2></td><td>../lib/tagmanager.js</td></tr><tr class="code">
<td class="docs">
<p>The Tag Manager handles the mappings between CSS selectors on view templates and web components. </p>

<h2>Todos</h2>

<ul><li>Make it dynamicly configurable</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">logger</span>        = <span class="variable">require</span>(<span class="string">'./logger.js'</span>).<span class="variable">getLogger</span>(<span class="string">'TagManager'</span>);

<span class="keyword">function</span> <span class="class">TagManager</span>() {

  <span class="keyword">var</span> <span class="variable">taglist</span> = [];

  <span class="this">this</span>.<span class="variable">addTag</span> = <span class="keyword">function</span> (<span class="variable">tag</span>) {
    <span class="variable">taglist</span>.<span class="variable">push</span>(<span class="variable">tag</span>);
  }

  <span class="this">this</span>.<span class="variable">setTagList</span> = <span class="keyword">function</span> (<span class="variable">tags</span>) {
    <span class="variable">taglist</span> = <span class="variable">tags</span>
  }</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>[TBD] This code sucks big time... 
I need to organize tags more efficiently to get rid of this ugly and buggy piece of code. 
Sizzle could be used, but it's most probably way too slow.</p>

<h2>Todos</h2>

<ul><li>find best match, selectors with predicated must be ranked higher</li><li>more than one module my map to a single element</li></ul>
</td>
<td class="code">
<pre><code><span class="this">this</span>.<span class="variable">getTag</span> = <span class="keyword">function</span> (<span class="variable">elem</span>, <span class="variable">attrs</span>, <span class="variable">prefix</span>, <span class="variable">uri</span>, <span class="variable">namespaces</span>) {
    <span class="comment">//logger.debug(JSON.stringify(arguments));</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">tag</span> = <span class="keyword">null</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">taglist</span>.<span class="variable">length</span>; <span class="variable">i</span>++) {
      <span class="variable">tag</span> = <span class="variable">taglist</span>[<span class="variable">i</span>];
      <span class="keyword">if</span> (<span class="variable">uri</span> !== <span class="keyword">null</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">tag</span>.<span class="variable">namespace</span> != <span class="string">''</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">tag</span>.<span class="variable">namespace</span> != <span class="variable">uri</span>) {
        <span class="comment">//logger.debug('tag has namespace, but no match'); </span>
        <span class="keyword">continue</span>;
      }

      <span class="keyword">var</span> <span class="variable">si</span> = <span class="variable">tag</span>.<span class="variable">selector</span>.<span class="variable">indexOf</span>(<span class="string">'['</span>);
      <span class="keyword">if</span> (<span class="variable">si</span> !== -<span class="number integer">1</span>) {
        <span class="keyword">var</span> <span class="variable">tagelem</span> = <span class="variable">tag</span>.<span class="variable">selector</span>.<span class="variable">substring</span>(<span class="number integer">0</span>, <span class="variable">si</span>),
            <span class="variable">preds</span> = {},
            <span class="variable">ps</span>, 
            <span class="variable">attrh</span> = {};
        <span class="variable">ps</span> = <span class="variable">tag</span>.<span class="variable">selector</span>.<span class="variable">substring</span>(<span class="variable">si</span>).<span class="variable">split</span>(<span class="string">']'</span>).<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">val</span>) {
          <span class="keyword">if</span> (<span class="variable">val</span> === <span class="string">''</span>) <span class="keyword">return</span>;
          <span class="variable">preds</span>[<span class="variable">val</span>.<span class="variable">substring</span>(<span class="number integer">1</span>, <span class="variable">val</span>.<span class="variable">indexOf</span>(<span class="string">'='</span>))] = <span class="variable">val</span>.<span class="variable">substring</span>(<span class="variable">val</span>.<span class="variable">indexOf</span>(<span class="string">'='</span>) + <span class="number integer">1</span>);
        });
        <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">j</span> = <span class="number integer">0</span>; <span class="variable">j</span> &<span class="variable">lt</span>; <span class="variable">attrs</span>.<span class="variable">length</span>; <span class="variable">j</span>++) {
          <span class="variable">attrh</span>[<span class="variable">attrs</span>[<span class="variable">j</span>][<span class="number integer">0</span>]] = <span class="variable">attrs</span>[<span class="variable">j</span>][<span class="number integer">1</span>];
        }
      } <span class="keyword">else</span> {
        <span class="keyword">var</span> <span class="variable">tagelem</span> = <span class="variable">tag</span>.<span class="variable">selector</span>;
      }

      <span class="keyword">var</span> <span class="variable">fe</span> = <span class="variable">true</span>;
      <span class="keyword">if</span> (<span class="variable">tagelem</span> !== <span class="variable">elem</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">tagelem</span> !== <span class="string">'*'</span>) {
        <span class="comment">//logger.debug('element name not matched');</span>
        <span class="variable">fe</span> = <span class="variable">false</span>;
        <span class="keyword">continue</span>;
      }

      <span class="keyword">var</span> <span class="variable">fp</span> = <span class="variable">true</span>
      <span class="keyword">if</span> (<span class="variable">si</span> !== -<span class="number integer">1</span>) {
        <span class="keyword">var</span> <span class="variable">count</span> = <span class="number integer">0</span>;
        <span class="keyword">for</span> (<span class="variable">pred</span> <span class="keyword">in</span> <span class="variable">preds</span>) {
          <span class="comment">//logger.debug('pred ' + pred + &quot;. &quot; + attrh[pred] + &quot;,&quot; + preds[pred]);</span>
          <span class="keyword">if</span> (<span class="variable">attrh</span>[<span class="variable">pred</span>] !== <span class="variable">preds</span>[<span class="variable">pred</span>]) {
            <span class="variable">fp</span> = <span class="variable">false</span>;
            <span class="comment">//logger.debug('attribute val not mached');</span>
            <span class="keyword">break</span>;
          }
          <span class="variable">count</span>++;
        }
        <span class="keyword">if</span> (<span class="variable">count</span> -<span class="number integer">1</span> &<span class="variable">gt</span>;= <span class="variable">j</span>) {
          <span class="variable">fp</span> = <span class="variable">false</span>;
          <span class="comment">//logger.debug('matched not all predicates');  </span>
          <span class="keyword">break</span>;
        }
      }

      <span class="keyword">if</span> (!<span class="variable">fp</span>) {
        <span class="comment">//logger.debug('attrs not matched');</span>
        <span class="keyword">continue</span>;
      }
      <span class="keyword">if</span> (!<span class="variable">fe</span>) {
        <span class="comment">//logger.debug('selector not matched');</span>
        <span class="keyword">continue</span>;
      }

      <span class="comment">//logger.debug('matching tag ' + tag.selector);</span>
      <span class="keyword">return</span> <span class="variable">tag</span>;
    }

    <span class="keyword">return</span> <span class="keyword">null</span>;
  }
}

<span class="variable">module</span>.<span class="variable">exports</span> = <span class="keyword">new</span> <span class="class">TagManager</span>();</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="../lib/modulecontainer.js"><a href="#">modulecontainer</a></h2></td><td>../lib/modulecontainer.js</td></tr><tr class="code">
<td class="docs">
<p>Module Container, Manager, Factory, whatever. All module related thingz must belong to us. </p>

<h2>Todos</h2>

<ul><li>scan the local module folder for web component descriptors as resources. </li><li>download module descriptors from remote web component hosts as resources. </li><li>provide web component objects.  </li><li><p>crud on module instances. </p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">mod_fs</span> = <span class="variable">require</span>(<span class="string">'fs'</span>)
	, <span class="variable">mod_resourcemanager</span> = <span class="variable">require</span>(<span class="string">'./resourcemanager.js'</span>)
	, <span class="variable">path</span> = <span class="variable">require</span>(<span class="string">'path'</span>)



<span class="keyword">function</span> <span class="variable">moduleRootFolder</span>() {
	<span class="keyword">return</span> <span class="variable">path</span>.<span class="variable">join</span>(<span class="variable">__dirname</span>, <span class="string">'..'</span>, <span class="string">'modules'</span>);
}

<span class="keyword">function</span> <span class="variable">scanFolder</span>(<span class="variable">folder</span>) {
	<span class="variable">mod_fs</span>.<span class="variable">readdir</span>(<span class="variable">moduleRootFolder</span>(), <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">files</span>) {
		<span class="keyword">if</span> (<span class="variable">err</span>) <span class="keyword">throw</span> <span class="variable">err</span>;

		<span class="variable">mod_resourcemanager</span>.<span class="variable">getResources</span>([<span class="string">'file://'</span> + <span class="variable">moduleRootFolder</span>() + <span class="string">'/app/htdocs/index.html'</span>]).<span class="variable">then</span>(<span class="keyword">function</span> () {
			<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'grunz...'</span>);	
		}); 
		
	});
}

<span class="variable">scanFolder</span>();</code></pre>
</td>
</tr>	</body>
</html></tbody></table>