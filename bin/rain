#!/usr/bin/env node

var fs = require('fs')
  , mod_path = require('path')
  , color = require('colors')
  , exec = require('child_process').exec
  , optimist = require('optimist')
  , wrench = require('wrench')
  , program = require('commander')
  , daemon = require('daemon')
  , platform_list = ["nodejs"]
  , utils   = require('./lib/utils.js')
  , sys_util = require('util');

process.title = "rain";

program
    .usage("<options> <command>")
    .option("-d, --debug", "debugging")
    .option("-c, --conf <path_to_conf>", "start server with custom configuration")
    .option("-m, --mothership-conf <path_to_conf>", "start server with custom mothership configuration")
    .option("-p, --platform <platform>", [
          "choose the platform for the application",
          "      Available platforms:            "+platform_list.join(', ')].join('\n'));

program
    .command("create-project <path> <project-name>")
    .description("create a project")
    .action(createProject);

program
    .command("create-component <component-name>")
    .description("create a component")
    .action(createComponent);

program
    .command("start [#pid]")
    .description([
       "1. on project root the command starts the server and creates an pid file"
    ].join('\n'))
    .action(start);

program
    .command("stop [#pid]")
    .description([
       "1. on project root the command stops the associated server",
       "2. with [#pid] stops the server with the associated process id"
    ].join('\n'))
    .action(stop);

program
    .command("restart [#pid]")
    .description([
       "1. on project root the command restarts the associated server",
       "2. with [#pid] restarts the server with the associated process id"
    ].join('\n'))
    .action(restart);

program
    .command("list [server|mothership]")
    .description("lists all running server/motherships, with [type] only 1 of both will be displayed")
    .action(list);

program
    .command("stopall")
    .description("shutting down all server and motherships")
    .action(stopall);


var extendedHelp = [
    '  Examples:'
    ,''
    ,'    $ rain create-project /home/username/workspace newProject'
    ,''
    ,'    $ rain start'
    ,'    $ rain start -c /home/username/workspace/custom_confs/server.conf'
    ,'    $ rain start -m /home/username/workspace/custom_confs/mothership.conf'
    ,''
    ,'    $ rain stop'
    ,'    $ rain stop 5361'
    ,''
].join('\n');

program.on('--help', function(){
  console.log(extendedHelp);
});

program.parse(process.argv);
if(!program.mothership && !program.debug && program.rawArgs.length <= 2)
  console.log(program.helpInformation()+'\n\n\n'+extendedHelp);

/**
 * create new application
 */
function createProject(path, project_name){
  var project_path = mod_path.join(mod_path.resolve(path), project_name);
  if(!mod_path.existsSync(project_path) && !utils.checkValidProject(project_path)){
    log("Directory "+project_path.blue+" does not exist!");
    program.confirm('Create Directory?  -  yes/no: ', function(yes){
      if(yes && setupProject(project_path)){
        program.confirm('Do you want to create a component?  -  yes/no: ', function(yes){
          if(yes){
            program.prompt('Componentname: ', function(name){
              //remove lineEnd
              name = name.replace(/\n$/, '');
              if(yes && name){
                setupComponent(project_path, name, function(){
                  projectCreated();
                });
              } else {
                log("Error: problem to setup component".red)
                projectCreated();
              }
            });
          } else {
            projectCreated();
          }
        });
      } else {
        log("Error: problem to setup the project".red);
      }
    });
  } else {
    log("Project exists!".red);
  }
  
  var projectCreated = function(){
    process.stdin.destroy();
    log(
        "Project created".green
        ,""
        ,"Go to the root directory of the project and start the server."
        ,"  $ cd "+project_path+" | rain start"
        ,""
        ,"Happy developing ;-)".rainbow
        ,""
      );
  }
};


function createComponent(component_name){
  var actPath = process.cwd();
  if(utils.checkValidProject(actPath)){
    setupComponent(actPath, component_name, function(){
      process.stdin.destroy();
    });
  } else {
    log(
        "This is not a rain project!".red
       ,"Please go to your project root and try it again!"
    )
  }  
};


function setupProject(project_path){
  //create project directory
  fs.mkdirSync(project_path, 0755);
  //create components directory
  fs.mkdirSync(mod_path.join(project_path, 'components'), 0755);
  //create conf directory
  fs.mkdirSync(mod_path.join(project_path, 'conf'), 0755);
  //copy default configurations
  wrench.copyDirSyncRecursive(mod_path.resolve(mod_path.join(__dirname, '../init/conf')), mod_path.join(project_path, 'conf'));
  wrench.chmodSyncRecursive(mod_path.resolve(mod_path.join(__dirname, '../init/conf')), 0755);
  
  //write ghostfile to know that is a rain project
  fs.writeFileSync(project_path+'/.rain', '');
  return true;
}

function setupComponent(project_path, component_name, callback){
  
  var components_path = mod_path.join(project_path, 'components');
  if(utils.componentExists(components_path)){
    console.log("Component already exists".red);
    return false;
  }
  console.log('Choose your platform:');
  program.choose(platform_list, function(i){
    //create component directory
    var comp_path = mod_path.join(components_path, component_name);
    fs.mkdirSync(comp_path, 0755);
    switch(platform_list[i]){
      case "wicket":
        console.log("wicket not implemented yet");
        break;
        
      case "pustefix":
        console.log("pustefix not implemented yet");
        break;
        
      case "nodejs":
      default:
        require('./lib/components/nodejs')({
          name : component_name,
          path : comp_path
        });
        break;
    }
    
    log(
      "Component created".green
      ,""
      ,"You can find your component in"
      ,comp_path.blue
    );
    if(callback)
      callback();
  });
};

function debug(){
  console.log(program);
};

function start(){
  var actPath     = process.cwd()
      ,server     = require('../lib/server_new')
      ,child      = require('child_process');
  
  if(!utils.checkPidDirectory())
    utils.createPidDirectory();
  
  if(!utils.checkValidProject(actPath)){
    console.log("this is not a rain project!".red);
    return false;
  }
  
  if(utils.serverIsUp(actPath)){
    console.log("server is still running!");
    return false;
  }
  
  //===========START MOTHERSHIP===========
  var ms = child.spawn('node', [__dirname+'/lib/start_mothership.js', program.mothershipConf ? program.mothershipConf : mod_path.join(actPath, 'conf', 'mothership.conf.default')]);
  ms.stdout.on('data', function(data){
    var data = data.toString();
    process.stdout.write(data);
    if(~data.search(/mothership started/i) || ~data.search("mothership is still running")){
      startServer();
    }
  })
  
  //===========MOTHERSHIP STARTED===========

  function startServer(){
    //===========START RAIN SERVER===========  
    var conf_path = program.conf ? program.conf : mod_path.join(actPath, 'conf', 'server.conf.default')
        ,server_conf = fs.readFileSync(conf_path, 'utf8')
        ,pid_path = utils.getPidDir();
    
    //start server
    server({'conf' : JSON.parse(server_conf)}, function(){
      daemon.daemonize(mod_path.join(actPath, 'server.log'), null, function(err, pid){
        var daemon_process = this.process;
        
        if (err) {
          return sys_util.puts('Error starting daemon: ' + err);
        }
        
        daemon_process.title = "rain-server";
        
        //create configurationfile
        var server_prop_file = pid+' '+conf_path
           ,conf_spid    = mod_path.join(pid_path, "rain.server."+pid)
           ,conf_project = mod_path.join(actPath, ".server");
        //write server config
        fs.writeFileSync(conf_spid, server_prop_file);
        fs.writeFileSync(conf_project, server_prop_file);
        //clear conf files if server shutting down
        daemon_process.on('SIGTERM', function(){
          fs.unlinkSync(conf_spid);
          fs.unlinkSync(conf_project);
          daemon_process.exit(0);
        });
        
        daemon_process.on('uncaughtException', function (err) {
          console.log('Caught exception: ' + err);
          daemon_process.kill(pid, 'SIGTERM');
        });
      });
    });
    //===========RAIN SERVER STARTED===========
  }
};

function stop(pid){
  if(!pid){
    var actPath = process.cwd();
    if(utils.checkValidProject(actPath)){
      if(utils.serverIsUp(actPath)){
        var result = fs.readFileSync(mod_path.join(actPath, '.server')).toString().match(/^([0-9]+)/);
        pid = result[1];
      } else {
        console.log('No running server for this project');
        process.exit(0);
      }
    } else {
      console.log("this is not a compatible project!".red);
      process.exit(1);
    }
  }
  process.kill(pid, 'SIGTERM');
  console.log("Server stopped!".green);
  process.exit(0);
};

function restart(){
  console.log("not implemented yet!".green);
};

function list(type){

  if(!type || type == 'mothership'){
    console.log("mothership list");
  }
  
  if(!type || type == 'server'){
    console.log("server list");
  }
};

function stopall(){
  var server = utils.getServerList(),
      motherships = utils.getMothershipList(),
      countServer = 0,
      countMS = 0;
  
  //shutdown all server
  for(var i = server.length; i--;){
    process.kill(server[i].substring(12),'SIGTERM');
    countServer++;
  }
  
  //shutdown all motherships
  for(var i = motherships.length; i--;){
    var result = motherships[i].match(/([0-9]+)$/);
    process.kill(result[1],'SIGTERM');
    countMS++;
  }
  
  console.log("%s Server shutted down!".green, countServer);
  console.log("%s Motherships shutted down!".green, countMS);
};



function log(){
  var arr_String = [''];
  for(var str in arguments){
    arr_String.push(arguments[str]);
  }
  console.log(arr_String.join('\n'));
};