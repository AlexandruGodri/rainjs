#!/usr/bin/env node

var fs = require('fs')
  , mod_path = require('path')
  , color = require('colors')
  , exec = require('child_process').exec
  , optimist = require('optimist')
  , wrench = require('wrench')
  , program = require('commander');

program
    .usage("<options> <command>")
    .option("-m, --mothership", "start with mothership")
    .option("-d, --debug", "debugging", function(){
      console.log(program);
    });

program
    .command("create-app <path> <app-name>")
    .description("create application project")
    .action(createApplication);

program
    .command("stop")
    .description("stop deamon server")
    .action(stop);

program
    .command("start")
    .description("start server as deamon")
    .action(start);

program
    .command("restart")
    .description("restart deamon server")
    .action(restart);


program.on('--help', function(){
  console.log('  Examples:');
  console.log('');
  console.log('    $ rain create-app /home/username/workspace newProject');
  console.log('    $ rain -m start');
  console.log('');
});

program.parse(process.argv);
var args = program.args;
checkOptions();

/**
 * create new application
 */
function createApplication(path, app_name){
  var app_path = mod_path.join(mod_path.resolve(path), app_name);
  if(!mod_path.existsSync(app_path)){
    console.log("Directory "+app_path.blue+" does not exist! Do you want to create it?");
  }
  wrench.copyDirSyncRecursive(mod_path.resolve(mod_path.join(__dirname, '../modules/_skeleton')), app_path);
  console.log("Created application :) Let it rain baby!!!".rainbow)
}

function debug(){
  console.log(program);
}

function start(){
  if(program.mothership)
    console.log("mothership started!".green);
  console.log("server started!".green);
}

function stop(){
  console.log("server stoped!".green);
}

function restart(){
  console.log("server restarted!".green);
}

function checkOptions(){
  /**
   * check create application rules
   */
  if(program.createApp){
    if(typeof program.createApp == 'boolean')
      console.log('You must set a path');
    
    if(!mod_path.existsSync(program.createApp))
      console.log("Path does not exist".red+": "+program.createApp);
    
    if(!args.a || typeof args.a == 'boolean' || args.a.length == 0)
      console.log("No application name provided! use "+"-a, --app-name".green+" to set it");
  }

  return true;
}